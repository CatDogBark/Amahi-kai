<div class="settings-table" id="disks-table">
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <a class="nav-link" href="<%= disks_engine.root_path %>"><%= t('disks') %></a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="<%= disks_engine.mounts_path %>"><%= t('mounts') %></a>
    </li>
    <li class="nav-item">
      <a class="nav-link active" href="<%= disks_engine.storage_pool_path %>"><%= t('storage_pool') %></a>
    </li>
  </ul>

  <!-- Greyhole Status -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><%= t('greyhole_status', default: 'Greyhole Status') %></h5>
      <% if @greyhole_status[:installed] %>
        <span class="badge <%= @greyhole_status[:running] ? 'bg-success' : 'bg-secondary' %>">
          <%= @greyhole_status[:running] ? t('running', default: 'Running') : t('stopped', default: 'Stopped') %>
        </span>
      <% else %>
        <span class="badge bg-warning text-dark"><%= t('not_installed', default: 'Not Installed') %></span>
      <% end %>
    </div>
    <div class="card-body">
      <% if @greyhole_status[:installed] %>
        <%= button_to(@greyhole_status[:running] ? t('stop', default: 'Stop') : t('start', default: 'Start'),
              disks_engine.toggle_greyhole_path,
              method: :post,
              class: "btn btn-sm #{@greyhole_status[:running] ? 'btn-outline-danger' : 'btn-outline-success'}") %>

        <% if @greyhole_status[:queue] %>
          <span class="ms-3 text-muted">
            <%= t('pending_operations', default: 'Pending operations') %>: <%= @greyhole_status[:queue][:pending] %>
          </span>
        <% end %>
      <% else %>
        <p class="text-muted mb-2"><%= t('greyhole_not_installed_msg', default: 'Greyhole is not installed. Install it to enable storage pooling and drive replication.') %></p>
        <button type="button" class="btn btn-primary" onclick="startGreyholeInstall()">
          Install Greyhole
        </button>
      <% end %>
    </div>
  </div>

  <!-- Pool Drives -->
  <div class="card mb-3">
    <div class="card-header">
      <h5 class="mb-0"><%= t('storage_pool_drives', default: 'Storage Pool Drives') %></h5>
    </div>
    <div class="card-body">
      <% if @pool_drives.any? %>
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th><%= t('path', default: 'Path') %></th>
              <th><%= t('total_space') %></th>
              <th><%= t('free_space') %></th>
              <th><%= t('used_space') %></th>
              <th><%= t('min_free', default: 'Min Free (GB)') %></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @pool_drives.each do |drive| %>
              <tr>
                <td><%= drive[:path] %></td>
                <td><%= number_to_human_size(drive[:total]) %></td>
                <td><%= number_to_human_size(drive[:free]) %></td>
                <td><%= number_to_human_size(drive[:used]) %></td>
                <td><%= drive[:minimum_free] %> GB</td>
                <td>
                  <%= button_to(t('remove', default: 'Remove'),
                        toggle_disk_pool_partition_shares_path(path: drive[:path]),
                        method: :put,
                        class: 'btn btn-sm btn-outline-danger',
                        data: { confirm: t('are_you_sure', default: 'Are you sure?') }) %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-muted mb-0"><%= t('no_pool_drives', default: 'No drives in the storage pool yet. Add partitions below.') %></p>
      <% end %>
    </div>
  </div>

  <!-- Available Partitions -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0"><%= t('available_partitions', default: 'Available Partitions') %></h5>
    </div>
    <div class="card-body">
      <% pool_paths = @pool_partitions.pluck(:path) %>
      <% if @partitions.any? %>
        <table class="table table-striped mb-0">
          <thead>
            <tr>
              <th><%= t('partition', default: 'Partition') %></th>
              <th><%= t('path', default: 'Path') %></th>
              <th><%= t('total_space') %></th>
              <th><%= t('free_space') %></th>
              <th><%= t('in_pool', default: 'In Pool') %></th>
            </tr>
          </thead>
          <tbody>
            <% @partitions.each do |part| %>
              <tr>
                <td><%= part[:device] %></td>
                <td><%= part[:path] %></td>
                <td><%= number_to_human_size(part[:bytes_total]) %></td>
                <td><%= number_to_human_size(part[:bytes_free]) %></td>
                <td>
                  <% checked = pool_paths.include?(part[:path]) %>
                  <%= render partial: 'share/disk_pooling_partition_checkbox',
                             locals: { checked: checked, path: part[:path] } %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p class="text-muted mb-0"><%= t('no_partitions', default: 'No partitions detected.') %></p>
      <% end %>
    </div>
  </div>
</div>


<!-- Greyhole Install Terminal Modal -->
<div id="greyhole-install-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:9999; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center;">
  <div style="width:700px; max-width:90vw; max-height:85vh; background:#1a1a2e; border-radius:12px; overflow:hidden; box-shadow:0 20px 60px rgba(0,0,0,0.5);">
    <div style="padding:16px 20px; background:#16213e; display:flex; align-items:center; justify-content:space-between;">
      <div style="display:flex; align-items:center; gap:8px;">
        <span style="width:12px; height:12px; border-radius:50%; background:#ff5f57;"></span>
        <span style="width:12px; height:12px; border-radius:50%; background:#febc2e;"></span>
        <span style="width:12px; height:12px; border-radius:50%; background:#28c840;"></span>
      </div>
      <span style="color:#7f8c9b; font-size:13px; font-family:monospace;">Installing Greyhole</span>
      <div style="width:52px;"></div>
    </div>
    <div id="greyhole-terminal" style="padding:20px; height:400px; overflow-y:auto; font-family:'SF Mono',Consolas,'Liberation Mono',Menlo,monospace; font-size:13px; line-height:1.6; color:#a0e8af;">
      <div id="greyhole-output"></div>
      <span id="greyhole-cursor" style="animation:blink 1s step-end infinite;">▌</span>
    </div>
    <div id="greyhole-install-footer" style="padding:12px 20px; background:#16213e; text-align:right; display:none;">
      <button type="button" class="btn btn-sm btn-outline-light" onclick="closeGreyholeModal()">Close & Refresh</button>
    </div>
  </div>
</div>

<style>
  @keyframes blink { 50% { opacity: 0; } }
  #greyhole-terminal::-webkit-scrollbar { width: 6px; }
  #greyhole-terminal::-webkit-scrollbar-track { background: transparent; }
  #greyhole-terminal::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
  .term-line { margin: 0; white-space: pre-wrap; word-break: break-all; }
  .term-line.step { color: #64b5f6; font-weight: bold; margin-top: 4px; }
  .term-line.success { color: #a0e8af; font-weight: bold; }
  .term-line.error { color: #ff6b6b; font-weight: bold; }
</style>

<script>
function startGreyholeInstall() {
  if (!confirm('This will install Greyhole and its dependencies. Continue?')) return;

  var modal = document.getElementById('greyhole-install-modal');
  modal.style.display = 'flex';
  var output = document.getElementById('greyhole-output');
  var cursor = document.getElementById('greyhole-cursor');
  var footer = document.getElementById('greyhole-install-footer');
  var terminal = document.getElementById('greyhole-terminal');
  output.innerHTML = '';

  var source = new EventSource('<%= disks_engine.install_greyhole_stream_path %>');

  source.onmessage = function(e) {
    var line = document.createElement('div');
    line.className = 'term-line';
    var text = e.data;

    if (text.match(/^(Adding|Updating|Installing|Setting up|Enabling|Generating)/)) {
      line.classList.add('step');
    } else if (text.match(/^✓/)) {
      line.classList.add('success');
    } else if (text.match(/^✗/)) {
      line.classList.add('error');
    }

    line.textContent = text;
    output.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  };

  source.addEventListener('done', function(e) {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
  });

  source.onerror = function() {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
    var line = document.createElement('div');
    line.className = 'term-line error';
    line.textContent = '✗ Connection lost';
    output.appendChild(line);
  };
}

function closeGreyholeModal() {
  document.getElementById('greyhole-install-modal').style.display = 'none';
  window.location.reload();
}
</script>
<div class="container-fluid">
  <% if @security_blockers.any? %>
    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
      âš  
      <div>
        <strong>Security issues must be fixed before enabling remote access.</strong><br>
        <%= @security_blockers.size %> blocker<%= @security_blockers.size == 1 ? '' : 's' %> found â€”
        <a href="#" class="alert-link" onclick="runSecurityAudit(); return false;">Run security audit</a>
        or <a href="<%= network_engine.security_path %>" class="alert-link">go to Security tab</a>
      </div>
    </div>
  <% end %>

  <!-- Cloudflare Tunnel Status -->
  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0">Cloudflare Tunnel</h5>
      <% if @tunnel_status[:installed] && @tunnel_status[:running] %>
        <span class="badge bg-success">Connected</span>
      <% elsif @tunnel_status[:installed] %>
        <span class="badge bg-warning text-dark">Stopped</span>
      <% else %>
        <span class="badge bg-secondary">Not Installed</span>
      <% end %>
    </div>
    <div class="card-body">
      <% if !@tunnel_status[:installed] %>
        <!-- Not installed -->
        <p class="text-muted">Cloudflare Tunnel lets you securely access your Amahi server from anywhere â€” no port forwarding needed.</p>
        <button type="button" class="btn btn-primary" onclick="openInstallTerminal('cloudflared', '<%= network_engine.install_cloudflared_stream_path %>')">
          Install cloudflared
        </button>

      <% elsif !@tunnel_status[:token_configured] %>
        <!-- Installed but no token -->
        <p class="mb-3">cloudflared is installed. Configure your tunnel token to connect.</p>

        <div class="card bg-light mb-3">
          <div class="card-body">
            <h6 class="card-title">Setup Instructions</h6>
            <p class="text-muted small mb-3">Cloudflare Tunnel creates a secure connection from your server to Cloudflare's network â€” no port forwarding, no exposed ports, no dynamic DNS.</p>

            <h6>Step 1: Create a Cloudflare account</h6>
            <ol class="mb-3">
              <li>Sign up at <a href="https://dash.cloudflare.com" target="_blank" rel="noopener">dash.cloudflare.com</a> (the free plan works)</li>
              <li>Add your domain â€” go to <strong>Websites</strong> â†’ <strong>Add a site</strong></li>
              <li>Follow Cloudflare's instructions to update your domain's nameservers at your registrar (e.g., Namecheap, GoDaddy)</li>
              <li>Wait for DNS to propagate (can take a few minutes to 24 hours)</li>
            </ol>

            <h6>Step 2: Create a tunnel</h6>
            <ol class="mb-3">
              <li>Go to <strong>Zero Trust</strong> (left sidebar) â†’ <strong>Networks</strong> â†’ <strong>Tunnels</strong></li>
              <li>Click <strong>Create a tunnel</strong></li>
              <li>Select tunnel type: <strong>Cloudflared</strong></li>
              <li>Name your tunnel (e.g., "amahi-kai" or "home-server")</li>
              <li>On the <strong>Install and run connectors</strong> page, find the tunnel token â€” it's the long string after <code>--token</code> in the install command</li>
              <li><strong>Don't run their install command</strong> â€” just copy the token. We'll handle the install.</li>
            </ol>

            <h6>Step 3: Route traffic (Published applications)</h6>
            <ol class="mb-3">
              <li>On the <strong>Route tunnel</strong> step, go to the <strong>Published applications</strong> tab</li>
              <li>Set the <strong>Subdomain</strong> (e.g., <code>nas</code>) and select your <strong>Domain</strong></li>
              <li>Leave <strong>Path</strong> empty (matches all paths)</li>
              <li>Under <strong>Service</strong>, set Type to <strong>HTTP</strong> and URL to <strong>localhost:3000</strong></li>
              <li>Click <strong>Save</strong></li>
              <li>Cloudflare will automatically create the DNS record for you</li>
            </ol>

            <h6>Step 4: Paste your token below</h6>
            <p class="text-muted small">Your server will connect to Cloudflare and be accessible at the hostname you configured (e.g., <code>nas.yourdomain.com</code>).</p>
          </div>
        </div>

        <form id="tunnel-token-form" class="d-flex gap-2">
          <input type="text" name="tunnel_token" class="form-control" placeholder="Paste your Cloudflare Tunnel token here" required style="font-family:monospace; font-size:0.85rem;">
          <button type="submit" class="btn btn-primary text-nowrap">
            Save & Connect
          </button>
        </form>

      <% else %>
        <!-- Configured -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="p-3 border rounded">
              <small class="text-muted d-block">Status</small>
              <strong><%= @tunnel_status[:running] ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Disconnected' %></strong>
            </div>
          </div>
          <% if @tunnel_status[:tunnel_url] %>
            <div class="col-md-6">
              <div class="p-3 border rounded">
                <small class="text-muted d-block">Tunnel URL</small>
                <a href="<%= @tunnel_status[:tunnel_url] %>" target="_blank" rel="noopener"><%= @tunnel_status[:tunnel_url] %></a>
              </div>
            </div>
          <% end %>
          <% if @tunnel_status[:connected_since] %>
            <div class="col-md-6">
              <div class="p-3 border rounded">
                <small class="text-muted d-block">Connected Since</small>
                <strong><%= @tunnel_status[:connected_since] %></strong>
              </div>
            </div>
          <% end %>
        </div>

        <div class="d-flex gap-2">
          <% if @tunnel_status[:running] %>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="tunnelAction('stop')">
              Stop
            </button>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="tunnelAction('restart')">
              Restart
            </button>
          <% else %>
            <button type="button" class="btn btn-success btn-sm" onclick="tunnelAction('start')">
              Start
            </button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= render 'shared/install_terminal', id: 'cloudflared', title: 'Installing cloudflared', stream_url: network_engine.install_cloudflared_stream_path %>
<%= render 'shared/install_terminal', id: 'security-audit', title: 'Security Audit', stream_url: network_engine.security_audit_stream_path %>
<%= render 'shared/install_terminal', id: 'security-fix', title: 'Applying Security Fixes', stream_url: network_engine.security_fix_stream_path %>

<script>
function runSecurityAudit() {
  var id = 'security-audit';
  var url = '<%= network_engine.security_audit_stream_path %>';
  var modal = document.getElementById(id + '-install-modal');
  var output = document.getElementById(id + '-output');
  var cursor = document.getElementById(id + '-cursor');
  var footer = document.getElementById(id + '-install-footer');
  var terminal = document.getElementById(id + '-terminal');

  modal.style.display = 'flex';
  output.innerHTML = '';
  cursor.style.display = '';
  footer.style.display = 'none';
  footer.innerHTML = '<button type="button" class="btn btn-sm btn-outline-light" onclick="closeInstallTerminal(\'security-audit\')">Close & Refresh</button>';

  var source = new EventSource(url);

  source.onmessage = function(e) {
    var line = document.createElement('div');
    line.className = 'term-line';
    var text = e.data;
    if (text.match(/^(Checking|Running)/)) { line.classList.add('step'); }
    else if (text.match(/^  âœ“/)) { line.classList.add('success'); }
    else if (text.match(/^  âœ—/) || text.match(/^âœ—/)) { line.classList.add('error'); }
    else if (text.match(/^  âš /) || text.match(/^âš /)) { line.classList.add('warn'); }
    else if (text.match(/^â”€â”€â”€/)) { line.style.color = '#7f8c9b'; line.style.fontWeight = 'bold'; line.style.marginTop = '8px'; }
    line.textContent = text;
    output.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  };

  source.addEventListener('has_fixable', function(e) {
    if (e.data === 'true') {
      var fixBtn = document.createElement('button');
      fixBtn.type = 'button';
      fixBtn.className = 'btn btn-sm btn-warning me-2';
      fixBtn.innerHTML = 'Fix All Issues';
      fixBtn.onclick = function() {
        closeInstallTerminal('security-audit');
        setTimeout(function() { openInstallTerminal('security-fix', '<%= network_engine.security_fix_stream_path %>'); }, 300);
      };
      footer.insertBefore(fixBtn, footer.firstChild);
    }
  });

  source.addEventListener('done', function(e) {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
  });

  source.onerror = function() {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
    var line = document.createElement('div');
    line.className = 'term-line error';
    line.textContent = 'âœ— Connection lost';
    output.appendChild(line);
  };
}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var form = document.getElementById('tunnel-token-form');
  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      var token = form.querySelector('[name=tunnel_token]').value;
      var btn = form.querySelector('button[type=submit]');
      btn.disabled = true;
      btn.innerHTML = 'Configuring...';

      fetch('<%= network_engine.configure_tunnel_path %>', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content },
        body: JSON.stringify({ tunnel_token: token })
      }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.status === 'ok') {
          window.location.reload();
        } else {
          alert('Error: ' + (data.error || 'Failed to configure tunnel'));
          btn.disabled = false;
          btn.innerHTML = 'Save & Connect';
        }
      }).catch(function() {
        alert('Request failed');
        btn.disabled = false;
        btn.innerHTML = 'Save & Connect';
      });
    });
  }
});

function tunnelAction(action) {
  var url = action === 'stop' ? '<%= network_engine.stop_tunnel_path %>' : '<%= network_engine.start_tunnel_path %>';
  fetch(url, {
    method: 'POST',
    headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content }
  }).then(function() { window.location.reload(); });
}
</script>

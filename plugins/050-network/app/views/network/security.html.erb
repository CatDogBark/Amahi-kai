<div class="container-fluid">
  <% if @has_blockers %>
    <div class="alert alert-danger mb-4">
      
      <strong>Security blockers found!</strong> Fix these issues before enabling remote access.
    </div>
  <% end %>

  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0">Security Audit</h5>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-sm btn-primary" onclick="runSecurityAudit()">
          Run Audit
        </button>
        <button type="button" class="btn btn-sm btn-warning" onclick="openInstallTerminal('security-fix', '<%= network_engine.security_fix_stream_path %>')">
          Fix All
        </button>
      </div>
    </div>
    <div class="card-body p-0">
      <table class="table table-hover mb-0">
        <thead>
          <tr>
            <th style="width:40px;"></th>
            <th>Check</th>
            <th>Severity</th>
            <th style="width:100px;"></th>
          </tr>
        </thead>
        <tbody>
          <% @checks.each do |check| %>
            <tr>
              <td class="text-center" style="vertical-align:middle;">
                <% case check.status %>
                <% when :pass %>
                  <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#d4edda;color:#155724;font-size:16px;font-weight:bold;" title="Pass">✓</span>
                <% when :warn %>
                  <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#fff3cd;color:#856404;font-size:16px;font-weight:bold;" title="Warning">⚠</span>
                <% when :fail %>
                  <span style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#f8d7da;color:#721c24;font-size:16px;font-weight:bold;" title="Failed">✗</span>
                <% end %>
              </td>
              <td style="vertical-align:middle;"><%= check.description %></td>
              <td>
                <% case check.severity %>
                <% when :blocker %>
                  <span class="badge bg-danger">Blocker</span>
                <% when :warning %>
                  <span class="badge bg-warning text-dark">Warning</span>
                <% when :info %>
                  <span class="badge bg-info text-dark">Info</span>
                <% end %>
              </td>
              <td>
                <% if check.status != :pass && check.fix_command && check.name != 'admin_password' && check.name != 'open_ports' && check.name != 'ssh_password_auth' %>
                  <button type="button" class="btn btn-sm btn-outline-primary" onclick="fixCheck('<%= check.name %>', this)">
                     Fix
                  </button>
                <% elsif check.name == 'admin_password' && check.status != :pass %>
                  <a href="/tab/settings" class="btn btn-sm btn-outline-warning">Change Password</a>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%= render 'shared/install_terminal', id: 'security-audit', title: 'Security Audit', stream_url: network_engine.security_audit_stream_path %>
<%= render 'shared/install_terminal', id: 'security-fix', title: 'Applying Security Fixes', stream_url: network_engine.security_fix_stream_path %>

<script>
function runSecurityAudit() {
  var id = 'security-audit';
  var url = '<%= network_engine.security_audit_stream_path %>';
  var modal = document.getElementById(id + '-install-modal');
  var output = document.getElementById(id + '-output');
  var cursor = document.getElementById(id + '-cursor');
  var footer = document.getElementById(id + '-install-footer');
  var terminal = document.getElementById(id + '-terminal');

  modal.style.display = 'flex';
  output.innerHTML = '';
  cursor.style.display = '';
  footer.style.display = 'none';

  // Reset footer to just the close button
  footer.innerHTML = '<button type="button" class="btn btn-sm btn-outline-light" onclick="closeInstallTerminal(\'security-audit\')">Close & Refresh</button>';

  var source = new EventSource(url);

  source.onmessage = function(e) {
    var line = document.createElement('div');
    line.className = 'term-line';
    var text = e.data;

    if (text.match(/^(Checking|Running)/)) {
      line.classList.add('step');
    } else if (text.match(/^  ✓/)) {
      line.classList.add('success');
    } else if (text.match(/^  ✗/) || text.match(/^✗/)) {
      line.classList.add('error');
    } else if (text.match(/^  ⚠/) || text.match(/^⚠/)) {
      line.classList.add('warn');
    } else if (text.match(/^───/)) {
      line.style.color = '#7f8c9b';
      line.style.fontWeight = 'bold';
      line.style.marginTop = '8px';
    }

    line.textContent = text;
    output.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  };

  source.addEventListener('has_fixable', function(e) {
    if (e.data === 'true') {
      // Add "Fix All Issues" button to footer
      var fixBtn = document.createElement('button');
      fixBtn.type = 'button';
      fixBtn.className = 'btn btn-sm btn-warning me-2';
      fixBtn.innerHTML = 'Fix All Issues';
      fixBtn.onclick = function() {
        // Hide audit modal without reloading (closeInstallTerminal reloads the page)
        document.getElementById('security-audit-install-modal').style.display = 'none';
        openInstallTerminal('security-fix', '<%= network_engine.security_fix_stream_path %>');
      };
      footer.insertBefore(fixBtn, footer.firstChild);
    }
  });

  source.addEventListener('done', function(e) {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
  });

  source.onerror = function() {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
    var line = document.createElement('div');
    line.className = 'term-line error';
    line.textContent = '✗ Connection lost';
    output.appendChild(line);
  };
}

function fixCheck(name, btn) {
  btn.disabled = true;
  btn.innerHTML = '';
  fetch('<%= network_engine.security_fix_path %>', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content },
    body: JSON.stringify({ check_name: name })
  }).then(function(r) { return r.json(); }).then(function(data) {
    if (data.status === 'ok') {
      window.location.reload();
    } else {
      alert('Fix failed for: ' + name);
      btn.disabled = false;
      btn.innerHTML = ' Fix';
    }
  }).catch(function() {
    btn.disabled = false;
    btn.innerHTML = ' Fix';
  });
}
</script>

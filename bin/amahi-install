#!/bin/bash
# bin/amahi-install — Amahi-kai native production installer for Ubuntu 24.04
# Idempotent: run it once on a blank server, run it again and nothing breaks.
set -euo pipefail

APP_DIR="/opt/amahi-kai"
CONFIG_DIR="/etc/amahi-kai"
ENV_FILE="$CONFIG_DIR/amahi.env"
SHARE_ROOT="/var/lib/amahi-kai/files"
RUBY_VERSION="3.2.10"
APP_USER="amahi"
APP_GROUP="amahi"

# Parse flags
HEADLESS=false
WITH_GREYHOLE=false
for arg in "$@"; do
  case "$arg" in
    --headless)     HEADLESS=true ;;
    --with-greyhole) WITH_GREYHOLE=true ;;
    --help|-h)
      echo "Usage: sudo bin/amahi-install [OPTIONS]"
      echo ""
      echo "Options:"
      echo "  --headless        Non-interactive install, generates random admin password"
      echo "  --with-greyhole   Install Greyhole storage pooling"
      echo "  --help            Show this help"
      exit 0
      ;;
    *)
      echo "Unknown option: $arg" >&2
      exit 1
      ;;
  esac
done

echo "============================================"
echo "  Amahi-kai Production Installer"
echo "  Target: Ubuntu 24.04 / Debian 12+"
if $HEADLESS; then
  echo "  Mode: HEADLESS"
fi
if $WITH_GREYHOLE; then
  echo "  Greyhole: YES"
fi
echo "============================================"
echo ""

# Must run as root
if [ "$(id -u)" -ne 0 ]; then
  echo "ERROR: This script must be run as root (or with sudo)." >&2
  exit 1
fi

# ---------------------------------------------------------------------------
# 0. Ensure swap exists (critical for low-RAM systems)
# ---------------------------------------------------------------------------
if ! swapon --show | grep -q '/'; then
  TOTAL_RAM_MB=$(awk '/MemTotal/ {printf "%d", $2/1024}' /proc/meminfo)
  if [ "$TOTAL_RAM_MB" -lt 8192 ]; then
    SWAP_SIZE="2G"
    [ "$TOTAL_RAM_MB" -lt 2048 ] && SWAP_SIZE="4G"
    echo "==> No swap detected (${TOTAL_RAM_MB}MB RAM) — creating ${SWAP_SIZE} swapfile..."
    fallocate -l "$SWAP_SIZE" /swapfile 2>/dev/null || dd if=/dev/zero of=/swapfile bs=1M count="${SWAP_SIZE%G}000" status=progress
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    if ! grep -q '/swapfile' /etc/fstab; then
      echo '/swapfile none swap sw 0 0' >> /etc/fstab
    fi
    echo "==> Swap enabled: ${SWAP_SIZE}"
  fi
else
  echo "==> Swap already active: $(swapon --show --noheadings | awk '{print $3}')"
fi

# ---------------------------------------------------------------------------
# 1. System packages
# ---------------------------------------------------------------------------
echo "==> Installing system dependencies..."
apt-get update
apt-get install -y --no-install-recommends \
  build-essential \
  curl \
  git \
  libffi-dev \
  libmariadb-dev \
  libssl-dev \
  libyaml-dev \
  zlib1g-dev \
  mariadb-server \
  samba \
  samba-common-bin \
  samba-vfs-modules \
  ntfs-3g \
  sudo

# VM guest agent (auto-detect)
if systemd-detect-virt -q 2>/dev/null; then
  VIRT_TYPE=$(systemd-detect-virt 2>/dev/null || true)
  echo "==> Virtual machine detected ($VIRT_TYPE), installing guest agent..."
  case "$VIRT_TYPE" in
    kvm|qemu)
      apt-get install -y --no-install-recommends qemu-guest-agent
      systemctl enable --now qemu-guest-agent 2>/dev/null || true
      ;;
    vmware)
      apt-get install -y --no-install-recommends open-vm-tools
      systemctl enable --now vmtoolsd 2>/dev/null || true
      ;;
    *)
      echo "  (no specific guest agent for $VIRT_TYPE)"
      ;;
  esac
fi

# Greyhole (optional)
# Disable memory-hungry services not needed on a NAS (~70MB savings)
for svc in fwupd.service multipathd.service; do
  if systemctl is-active --quiet "$svc" 2>/dev/null; then
    echo "==> Disabling $svc (not needed, saves memory)..."
    systemctl stop "$svc" 2>/dev/null || true
    systemctl disable "$svc" 2>/dev/null || true
    systemctl mask "$svc" 2>/dev/null || true
  fi
done

if $WITH_GREYHOLE; then
  echo "==> Adding Greyhole apt repository..."
  if [ ! -f /usr/share/keyrings/greyhole-archive-keyring.asc ]; then
    curl -fsSL -o /usr/share/keyrings/greyhole-archive-keyring.asc https://www.greyhole.net/releases/deb/greyhole-debsig.asc
  fi
  if [ ! -f /etc/apt/sources.list.d/greyhole.list ]; then
    echo "deb [signed-by=/usr/share/keyrings/greyhole-archive-keyring.asc] https://www.greyhole.net/releases/deb stable main" > /etc/apt/sources.list.d/greyhole.list
    apt-get update
  fi
  echo "==> Installing Greyhole and PHP dependencies..."
  apt-get install -y --no-install-recommends \
    greyhole \
    php \
    php8.3-mysql \
    php8.3-mbstring
fi

# ---------------------------------------------------------------------------
# 2. Ruby — prefer system package, fall back to rbenv
# ---------------------------------------------------------------------------
SYSTEM_RUBY_VERSION=$(ruby -e 'puts RUBY_VERSION' 2>/dev/null || true)
NEED_RBENV=true

if [ -n "$SYSTEM_RUBY_VERSION" ]; then
  # Check if system Ruby major.minor matches what we need (3.2.x)
  REQUIRED_MINOR=$(echo "$RUBY_VERSION" | cut -d. -f1,2)
  SYSTEM_MINOR=$(echo "$SYSTEM_RUBY_VERSION" | cut -d. -f1,2)
  if [ "$SYSTEM_MINOR" = "$REQUIRED_MINOR" ]; then
    echo "==> System Ruby $SYSTEM_RUBY_VERSION detected (matches $REQUIRED_MINOR.x) — using it"
    NEED_RBENV=false
  else
    echo "==> System Ruby $SYSTEM_RUBY_VERSION does not match required $REQUIRED_MINOR.x"
  fi
fi

if [ "$NEED_RBENV" = true ]; then
  # Try installing Ruby from apt first (Ubuntu 24.04 ships 3.2)
  echo "==> Attempting to install Ruby from system packages..."
  apt-get install -y --no-install-recommends ruby ruby-dev ruby-bundler 2>/dev/null || true

  SYSTEM_RUBY_VERSION=$(ruby -e 'puts RUBY_VERSION' 2>/dev/null || true)
  REQUIRED_MINOR=$(echo "$RUBY_VERSION" | cut -d. -f1,2)
  SYSTEM_MINOR=$(echo "$SYSTEM_RUBY_VERSION" | cut -d. -f1,2)

  if [ -n "$SYSTEM_RUBY_VERSION" ] && [ "$SYSTEM_MINOR" = "$REQUIRED_MINOR" ]; then
    echo "==> System Ruby $SYSTEM_RUBY_VERSION installed from packages"
    NEED_RBENV=false
  fi
fi

if [ "$NEED_RBENV" = true ]; then
  echo "==> System Ruby not available or wrong version — building via rbenv..."
  if [ ! -d "/usr/local/rbenv" ]; then
    echo "==> Installing rbenv + ruby-build system-wide..."
    git clone https://github.com/rbenv/rbenv.git /usr/local/rbenv
    git clone https://github.com/rbenv/ruby-build.git /usr/local/rbenv/plugins/ruby-build
  fi

  export RBENV_ROOT="/usr/local/rbenv"
  export PATH="$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH"

  if ! rbenv versions --bare | grep -q "^${RUBY_VERSION}$"; then
    echo "==> Installing Ruby ${RUBY_VERSION} from source (this takes a few minutes)..."
    rbenv install "$RUBY_VERSION"
  fi
  rbenv global "$RUBY_VERSION"
  rbenv rehash

  # Make rbenv available to all users
  cat > /etc/profile.d/rbenv.sh <<'RBENV'
export RBENV_ROOT="/usr/local/rbenv"
export PATH="$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH"
eval "$(rbenv init - bash)"
RBENV
fi

# System Ruby 3.2 ships with bundler 2.4.19 which matches Gemfile.lock
# Do NOT install a newer bundler — version mismatches break native extensions
if command -v rbenv &>/dev/null; then
  rbenv rehash
fi

# ---------------------------------------------------------------------------
# 3. Create system user
# ---------------------------------------------------------------------------
if ! id "$APP_USER" &>/dev/null; then
  echo "==> Creating system user '$APP_USER'..."
  useradd --system --create-home --shell /bin/bash --user-group "$APP_USER"
else
  echo "==> User '$APP_USER' already exists (skipping)"
fi

# ---------------------------------------------------------------------------
# 4. Deploy application code
# ---------------------------------------------------------------------------
echo "==> Deploying application to $APP_DIR..."
mkdir -p "$APP_DIR"

if [ -d "$APP_DIR/.git" ]; then
  echo "    Existing installation found, pulling latest..."
  chown -R "$APP_USER:$APP_GROUP" "$APP_DIR"
  sudo -u "$APP_USER" git config --global --add safe.directory "$APP_DIR" 2>/dev/null || true
  cd "$APP_DIR"
  sudo -u "$APP_USER" git pull origin main 2>&1 || echo "    ⚠ Git pull failed — using code on disk"
elif [ -f "$APP_DIR/Gemfile" ]; then
  echo "    Existing installation found (no git), using current code..."
  cd "$APP_DIR"
else
  # If we're running from a git checkout, copy it; otherwise clone
  SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
  if [ -d "$SCRIPT_DIR/.git" ]; then
    echo "    Copying from local checkout..."
    rsync -a --exclude='.git' --exclude='tmp' --exclude='log' --exclude='node_modules' \
      "$SCRIPT_DIR/" "$APP_DIR/"
  else
    echo "    Cloning from GitHub..."
    sudo -u "$APP_USER" git clone https://github.com/CatDogBark/Amahi-kai.git "$APP_DIR"
  fi
fi

cd "$APP_DIR"
mkdir -p tmp/pids tmp/cache tmp/sockets log
chown -R "$APP_USER:$APP_GROUP" "$APP_DIR"

# Ensure git trusts this directory (prevents "dubious ownership" errors)
sudo -u "$APP_USER" git config --global --add safe.directory "$APP_DIR" 2>/dev/null || true

# ---------------------------------------------------------------------------
# 5. Create directories + config (must happen before bundle/DB steps)
# ---------------------------------------------------------------------------
echo "==> Creating data directories..."
mkdir -p "$SHARE_ROOT"
chown "$APP_USER:users" "$SHARE_ROOT"
chmod 2775 "$SHARE_ROOT"
mkdir -p "$CONFIG_DIR"
mkdir -p /var/lib/amahi-kai/dbs
mkdir -p /var/lib/amahi-kai/tmp
chown "$APP_USER:$APP_GROUP" /var/lib/amahi-kai/tmp

# ---------------------------------------------------------------------------
# 6. Generate config (if not exists)
# ---------------------------------------------------------------------------
if [ ! -f "$ENV_FILE" ]; then
  echo "==> Generating configuration..."
  SECRET=$(openssl rand -hex 32)
  DB_PASS=$(openssl rand -hex 16)
  cat > "$ENV_FILE" <<EOF
# Amahi-kai production configuration
# Generated by bin/amahi-install on $(date -Iseconds)

SECRET_KEY_BASE=$SECRET
RAILS_ENV=production

# Serve static assets from Puma (no nginx reverse proxy in front)
RAILS_SERVE_STATIC_FILES=true

DATABASE_HOST=localhost
DATABASE_NAME=amahi_production
DATABASE_USER=amahi
DATABASE_PASSWORD=$DB_PASS
AMAHI_DUMMY_MODE=false

# Allow access via Cloudflare Tunnel (set to your domain, or remove if not using one)
# RAILS_ALLOWED_HOST=your-domain.example.com

# Share root (default: /var/lib/amahi-kai/files)
# AMAHI_SHARE_ROOT=/var/lib/amahi-kai/files
EOF
  chmod 640 "$ENV_FILE"
  chown root:"$APP_USER" "$ENV_FILE"
  echo "    Config written to $ENV_FILE"
else
  echo "    Config already exists at $ENV_FILE (skipping)"
  chmod 640 "$ENV_FILE"
  chown root:"$APP_USER" "$ENV_FILE"
fi

# Source the env file for DB setup
set -a
source "$ENV_FILE"
set +a

# ---------------------------------------------------------------------------
# 8. MariaDB setup
# ---------------------------------------------------------------------------
echo "==> Configuring MariaDB..."
systemctl enable --now mariadb

# Create database and user (idempotent)
mysql -u root <<EOSQL || true
CREATE DATABASE IF NOT EXISTS \`${DATABASE_NAME:-amahi_production}\`;
CREATE USER IF NOT EXISTS '${DATABASE_USER:-amahi}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD:-amahi}';
ALTER USER '${DATABASE_USER:-amahi}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD:-amahi}';
GRANT ALL PRIVILEGES ON \`${DATABASE_NAME:-amahi_production}\`.* TO '${DATABASE_USER:-amahi}'@'localhost';
FLUSH PRIVILEGES;
EOSQL

# Greyhole database (if installed)
if $WITH_GREYHOLE; then
  echo "==> Creating Greyhole database..."
  mysql -u root <<EOSQL || true
CREATE DATABASE IF NOT EXISTS greyhole;
GRANT ALL PRIVILEGES ON greyhole.* TO '${DATABASE_USER:-amahi}'@'localhost';
FLUSH PRIVILEGES;
EOSQL
  # Initialize Greyhole schema if available
  if [ -f /usr/share/greyhole/schema-mysql.sql ]; then
    mysql -u root greyhole < /usr/share/greyhole/schema-mysql.sql 2>/dev/null || true
  fi
fi

# ---------------------------------------------------------------------------
# 9. Bundle install
# ---------------------------------------------------------------------------
echo "==> Installing Ruby gems..."

# If using system Ruby, disable rbenv to prevent shim conflicts
# (rbenv may exist from a previous install with a different Ruby platform)
if [ "$NEED_RBENV" = false ] && [ -f /etc/profile.d/rbenv.sh ]; then
  echo "    Disabling rbenv (using system Ruby instead)..."
  mv /etc/profile.d/rbenv.sh /etc/profile.d/rbenv.sh.disabled 2>/dev/null || true
  # Also clear rbenv from current shell
  export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v rbenv | tr '\n' ':' | sed 's/:$//')
  unset RBENV_ROOT 2>/dev/null || true
  hash -r
fi

sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && bundle config set --local path 'vendor/bundle' && bundle config set --local without 'development test' && bundle install --jobs 4"

# ---------------------------------------------------------------------------
# 10. Sudoers allowlist (must be before db:seed — User creation runs system commands)
# ---------------------------------------------------------------------------
echo "==> Installing sudoers allowlist..."
cat > /etc/sudoers.d/amahi-kai <<'SUDOERS'
# Amahi-kai — least-privilege sudoers allowlist
# See docs/security/PRIVILEGE-ESCALATION-MITIGATION.md

# User management
amahi ALL=(root) NOPASSWD: /usr/sbin/useradd
amahi ALL=(root) NOPASSWD: /usr/sbin/usermod
amahi ALL=(root) NOPASSWD: /usr/sbin/userdel

# Samba password management
amahi ALL=(root) NOPASSWD: /usr/bin/pdbedit

# File operations — scoped to share and SSH paths
amahi ALL=(root) NOPASSWD: /usr/bin/chmod [0-9]* /var/lib/amahi-kai/*
amahi ALL=(root) NOPASSWD: /usr/bin/chmod -R [a-z]* /var/lib/amahi-kai/*
amahi ALL=(root) NOPASSWD: /usr/bin/chmod [a-z]* /var/lib/amahi-kai/*
amahi ALL=(root) NOPASSWD: /usr/bin/chmod u+rwx\,go-rwx /home/*/.ssh
amahi ALL=(root) NOPASSWD: /usr/bin/chmod u+rw\,go-rwx /home/*/.ssh/authorized_keys
amahi ALL=(root) NOPASSWD: /usr/bin/chown * /var/lib/amahi-kai/*
amahi ALL=(root) NOPASSWD: /usr/bin/chown -R * /home/*/.ssh

# Directory creation for shares
amahi ALL=(root) NOPASSWD: /usr/bin/mkdir -p /var/lib/amahi-kai/*

# Config file staging
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/amahi-staging/* /etc/samba/*
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/amahi-staging/* /etc/dnsmasq.d/*
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/lib/amahi-kai/tmp/* /etc/samba/*
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/lib/amahi-kai/tmp/* /etc/dnsmasq.d/*

# Service management — scoped to Amahi-managed services ONLY
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable dnsmasq.service

# Hostname management
amahi ALL=(root) NOPASSWD: /usr/bin/hostnamectl set-hostname *

# Database backups
amahi ALL=(root) NOPASSWD: /usr/bin/mysqldump

# Greyhole service management
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl status greyhole.service

# Greyhole config management
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/lib/amahi-kai/tmp/* /etc/greyhole.conf

# Greyhole installation (web UI triggered)
amahi ALL=(root) NOPASSWD: SETENV: /usr/bin/apt-get update
amahi ALL=(root) NOPASSWD: SETENV: /usr/bin/apt-get install *
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/greyhole-debsig.asc /usr/share/keyrings/greyhole-archive-keyring.asc
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/greyhole.list /etc/apt/sources.list.d/greyhole.list
amahi ALL=(root) NOPASSWD: /usr/bin/tee /etc/greyhole.conf
amahi ALL=(root) NOPASSWD: /usr/bin/mysql -u root *
amahi ALL=(root) NOPASSWD: /usr/bin/dpkg --configure -a
amahi ALL=(root) NOPASSWD: /usr/sbin/phpenmod *

# Disk management (web UI)
amahi ALL=(root) NOPASSWD: /sbin/mkfs.ext4 *
amahi ALL=(root) NOPASSWD: /bin/mount *
amahi ALL=(root) NOPASSWD: /bin/umount *
amahi ALL=(root) NOPASSWD: /usr/bin/mkdir -p /mnt/*
amahi ALL=(root) NOPASSWD: /usr/bin/rmdir /mnt/*
amahi ALL=(root) NOPASSWD: /usr/bin/mkdir -p /opt/amahi/*
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/amahi-staging/* /opt/amahi/*
amahi ALL=(root) NOPASSWD: /usr/bin/rm -rf /opt/amahi/apps/*
amahi ALL=(root) NOPASSWD: /usr/bin/tee -a /etc/fstab
amahi ALL=(root) NOPASSWD: /usr/bin/lsblk *
amahi ALL=(root) NOPASSWD: /sbin/blkid *
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/fstab.new /etc/fstab

# Docker installation (web UI triggered)
amahi ALL=(root) NOPASSWD: /usr/bin/gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
amahi ALL=(root) NOPASSWD: /usr/bin/tee /etc/apt/sources.list.d/docker.list
amahi ALL=(root) NOPASSWD: /usr/sbin/usermod -aG docker amahi
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable docker
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start docker
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop docker
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart docker
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl is-active docker
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl is-active --quiet docker
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl status docker

# Docker container management (app install/uninstall/start/stop)
amahi ALL=(root) NOPASSWD: /usr/bin/docker
amahi ALL=(root) NOPASSWD: /usr/sbin/smartctl

# Cloudflare Tunnel
amahi ALL=(root) NOPASSWD: /usr/bin/cloudflared
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/lib/amahi-kai/tmp/cloudflared.service /etc/systemd/system/cloudflared.service
amahi ALL=(root) NOPASSWD: /usr/bin/rm -f /etc/systemd/system/cloudflared*
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl daemon-reload
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start cloudflared
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop cloudflared
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart cloudflared
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable cloudflared
amahi ALL=(root) NOPASSWD: /usr/bin/mkdir -p /etc/amahi-kai
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/lib/amahi-kai/tmp/tunnel.token /etc/amahi-kai/tunnel.token
amahi ALL=(root) NOPASSWD: SETENV: /usr/bin/apt-get install -y cloudflared

# Tailscale VPN
amahi ALL=(root) NOPASSWD: /usr/bin/bash /tmp/tailscale-install.sh
amahi ALL=(root) NOPASSWD: /usr/bin/tailscale
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start tailscaled
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop tailscaled
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart tailscaled
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable tailscaled
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable tailscaled
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl is-active tailscaled
amahi ALL=(root) NOPASSWD: /usr/bin/tee /etc/apt/sources.list.d/cloudflared.list
amahi ALL=(root) NOPASSWD: /usr/bin/gpg --dearmor -o /usr/share/keyrings/cloudflare-archive-keyring.gpg

# Self-update
amahi ALL=(root) NOPASSWD: /opt/amahi-kai/bin/amahi-update
amahi ALL=(root) NOPASSWD: /opt/amahi-kai/bin/amahi-update --stream
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart amahi-kai
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl status amahi-kai

# Security hardening
amahi ALL=(root) NOPASSWD: /usr/sbin/ufw *
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart sshd
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart ssh
amahi ALL=(root) NOPASSWD: SETENV: /usr/bin/apt-get install -y fail2ban
amahi ALL=(root) NOPASSWD: SETENV: /usr/bin/apt-get install -y unattended-upgrades
amahi ALL=(root) NOPASSWD: /usr/bin/dpkg-reconfigure -plow unattended-upgrades
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/lib/amahi-kai/tmp/sshd_config /etc/ssh/sshd_config
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/lib/amahi-kai/tmp/smb.conf /etc/samba/smb.conf
amahi ALL=(root) NOPASSWD: /usr/bin/fallocate -l * /swapfile
amahi ALL=(root) NOPASSWD: /usr/bin/dd if=/dev/zero of=/swapfile *
amahi ALL=(root) NOPASSWD: /usr/bin/chmod 600 /swapfile
amahi ALL=(root) NOPASSWD: /sbin/mkswap /swapfile
amahi ALL=(root) NOPASSWD: /sbin/swapon /swapfile
SUDOERS
chmod 440 /etc/sudoers.d/amahi-kai
visudo -cf /etc/sudoers.d/amahi-kai
echo "    Sudoers validated OK"

# ---------------------------------------------------------------------------
# 11. Database migrations
# ---------------------------------------------------------------------------
echo "==> Running database migrations..."
bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails db:migrate"

echo "==> Seeding database..."
bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails db:seed"

# Detect host IP and patch network settings to match this machine
HOST_IP=$(hostname -I | awk '{print $1}')
if [ -n "$HOST_IP" ]; then
  NET_PREFIX=$(echo "$HOST_IP" | cut -d. -f1-3)
  SELF_ADDR=$(echo "$HOST_IP" | cut -d. -f4)
  echo "==> Configuring network settings for $HOST_IP..."
  bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails runner \"
    Setting.set('net', '$NET_PREFIX')
    Setting.set('self-address', '$SELF_ADDR')
  \""
fi

# Headless mode: generate random password and mark setup complete
if $HEADLESS; then
  ADMIN_PASS=$(openssl rand -base64 16 | tr -d '/+=' | head -c 20)
  echo "==> Headless mode: configuring admin account..."
  bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails runner \"
    user = User.find_by(login: 'admin')
    user.password = '$ADMIN_PASS'
    user.password_confirmation = '$ADMIN_PASS'
    user.save!
    Setting.set('setup_completed', 'true')
  \""
fi

# ---------------------------------------------------------------------------
# 10. Asset precompilation
# ---------------------------------------------------------------------------
echo "==> Precompiling assets..."
rm -rf "$APP_DIR/tmp/cache/assets"
chown -R "$APP_USER:$APP_GROUP" "$APP_DIR"
sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails assets:precompile"

# ---------------------------------------------------------------------------
# 12. Systemd service (with RAILS_LOG_TO_STDOUT)
# ---------------------------------------------------------------------------
echo "==> Installing systemd service..."

# Detect Ruby path — system or rbenv
if [ "$NEED_RBENV" = true ]; then
  RUBY_ENV_LINES="Environment=RBENV_ROOT=/usr/local/rbenv
Environment=PATH=/usr/local/rbenv/shims:/usr/local/rbenv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"
  BUNDLE_PATH="/usr/local/rbenv/shims/bundle"
else
  RUBY_ENV_LINES="Environment=PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin"
  BUNDLE_PATH="$(which bundle)"
fi

cat > /etc/systemd/system/amahi-kai.service <<UNIT
[Unit]
Description=Amahi-kai Home Server (Puma)
After=network.target mariadb.service
Requires=mariadb.service

[Service]
Type=simple
User=$APP_USER
Group=$APP_GROUP
WorkingDirectory=$APP_DIR
EnvironmentFile=$ENV_FILE
$RUBY_ENV_LINES
Environment=RAILS_LOG_TO_STDOUT=true
ExecStart=$BUNDLE_PATH exec puma -C config/puma.rb
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=amahi-kai

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable amahi-kai

# ---------------------------------------------------------------------------
# 13. Firewall — open port 3000 (Puma direct)
# ---------------------------------------------------------------------------
if command -v ufw &>/dev/null && ufw status | grep -q "Status: active"; then
  echo "==> Opening port 3000 in UFW..."
  ufw allow 3000/tcp comment "Amahi-kai web UI (Puma)" || true
fi

# ---------------------------------------------------------------------------
# 14. Enable services (Samba)
# ---------------------------------------------------------------------------
echo "==> Configuring Samba globals..."
if [ -f /etc/samba/smb.conf ]; then
  # Ensure required global settings for Amahi-kai
  for setting in "wins support = yes" "wide links = yes" "follow symlinks = yes" "allow insecure wide links = yes" "unix extensions = no"; do
    key=$(echo "$setting" | cut -d= -f1 | xargs)
    if ! grep -qi "^[[:space:]]*$key" /etc/samba/smb.conf; then
      sed -i "/^\[global\]/a\\\\t$setting" /etc/samba/smb.conf
    fi
  done
fi

echo "==> Enabling services..."
# Clean stale WINS database (causes nmbd segfault on fresh installs)
rm -f /var/lib/samba/wins.dat /var/cache/samba/wins.tdb
systemctl enable --now smbd nmbd
# dnsmasq disabled by default — enable when DNS aliases are configured
# systemctl enable --now dnsmasq

# Greyhole (enable but don't start — wizard or user configures drives first)
if $WITH_GREYHOLE && command -v greyhole &>/dev/null; then
  echo "==> Enabling Greyhole service..."
  systemctl enable greyhole || true
fi

# ---------------------------------------------------------------------------
# 15. File search index
# ---------------------------------------------------------------------------
echo "==> Building file search index..."
bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails shares:reindex" || true

# Systemd timer for periodic index updates (every 10 minutes)
cat > /etc/systemd/system/amahi-kai-indexer.service <<UNIT
[Unit]
Description=Amahi-kai Share File Indexer
After=amahi-kai.service mariadb.service

[Service]
Type=oneshot
User=$APP_USER
Group=$APP_GROUP
WorkingDirectory=$APP_DIR
EnvironmentFile=$ENV_FILE
$RUBY_ENV_LINES
ExecStart=$BUNDLE_PATH exec rails shares:update_index
StandardOutput=journal
StandardError=journal
SyslogIdentifier=amahi-kai-indexer
UNIT

cat > /etc/systemd/system/amahi-kai-indexer.timer <<TIMER
[Unit]
Description=Amahi-kai Share File Index Update (every 10 min)

[Timer]
OnBootSec=2min
OnUnitActiveSec=10min

[Install]
WantedBy=timers.target
TIMER

systemctl daemon-reload
systemctl enable --now amahi-kai-indexer.timer

# ---------------------------------------------------------------------------
# 16. Start Amahi-kai
# ---------------------------------------------------------------------------
echo "==> Starting Amahi-kai..."
systemctl start amahi-kai

echo ""
echo "============================================"
echo "  Amahi-kai installation complete!"
echo "============================================"
echo ""
echo "  Web UI:  http://$(hostname -I | awk '{print $1}'):3000"
echo "  Tunnel:  (configure Cloudflare Tunnel if needed)"
if $HEADLESS; then
  echo ""
  echo "  ┌─────────────────────────────────────┐"
  echo "  │  ADMIN CREDENTIALS (save these!)    │"
  echo "  │                                     │"
  echo "  │  Username: admin                    │"
  echo "  │  Password: $ADMIN_PASS"
  echo "  │                                     │"
  echo "  │  Setup wizard: SKIPPED (headless)   │"
  echo "  └─────────────────────────────────────┘"
  echo ""
else
  echo "  Login:   admin / secretpassword"
  echo "  NOTE:    The setup wizard will guide you through"
  echo "           initial configuration on first login."
  echo ""
fi
echo "  Config:  $ENV_FILE"
echo "  App:     $APP_DIR"
echo "  Shares:  $SHARE_ROOT"
echo "  Logs:    journalctl -u amahi-kai -f"
echo ""
echo "  Services:"
echo "    systemctl status amahi-kai   # Rails app (Puma on :3000)"
echo "    systemctl status mariadb     # Database"
echo "    systemctl status smbd        # Samba file sharing"
if $WITH_GREYHOLE; then
  echo "    systemctl status greyhole    # Storage pooling"
fi
echo ""

#!/bin/bash
# bin/amahi-install — Amahi-kai native production installer for Ubuntu 24.04
# Idempotent: run it once on a blank server, run it again and nothing breaks.
set -euo pipefail

APP_DIR="/opt/amahi-kai"
CONFIG_DIR="/etc/amahi-kai"
ENV_FILE="$CONFIG_DIR/amahi.env"
SHARE_ROOT="/var/hda/files"
RUBY_VERSION="3.2.10"
APP_USER="amahi"
APP_GROUP="amahi"

# Parse flags
HEADLESS=false
WITH_GREYHOLE=false
for arg in "$@"; do
  case "$arg" in
    --headless)     HEADLESS=true ;;
    --with-greyhole) WITH_GREYHOLE=true ;;
    --help|-h)
      echo "Usage: sudo bin/amahi-install [OPTIONS]"
      echo ""
      echo "Options:"
      echo "  --headless        Non-interactive install, generates random admin password"
      echo "  --with-greyhole   Install Greyhole storage pooling"
      echo "  --help            Show this help"
      exit 0
      ;;
    *)
      echo "Unknown option: $arg" >&2
      exit 1
      ;;
  esac
done

echo "============================================"
echo "  Amahi-kai Production Installer"
echo "  Target: Ubuntu 24.04 / Debian 12+"
if $HEADLESS; then
  echo "  Mode: HEADLESS"
fi
if $WITH_GREYHOLE; then
  echo "  Greyhole: YES"
fi
echo "============================================"
echo ""

# Must run as root
if [ "$(id -u)" -ne 0 ]; then
  echo "ERROR: This script must be run as root (or with sudo)." >&2
  exit 1
fi

# ---------------------------------------------------------------------------
# 1. System packages
# ---------------------------------------------------------------------------
echo "==> Installing system dependencies..."
apt-get update
apt-get install -y --no-install-recommends \
  build-essential \
  curl \
  git \
  libffi-dev \
  libgdbm-dev \
  libmariadb-dev \
  libncurses5-dev \
  libreadline-dev \
  libssl-dev \
  libyaml-dev \
  mariadb-server \
  samba \
  samba-common-bin \
  dnsmasq \
  sudo \
  zlib1g-dev \
  autoconf \
  bison \
  rustc  # needed for some gem native extensions on newer Ruby

# Greyhole (optional)
if $WITH_GREYHOLE; then
  echo "==> Adding Greyhole apt repository..."
  if [ ! -f /usr/share/keyrings/greyhole-archive-keyring.gpg ]; then
    curl -s https://www.greyhole.net/releases/deb/greyhole-debsig.asc | gpg --dearmor -o /usr/share/keyrings/greyhole-archive-keyring.gpg
  fi
  if [ ! -f /etc/apt/sources.list.d/greyhole.list ]; then
    echo "deb [signed-by=/usr/share/keyrings/greyhole-archive-keyring.gpg] https://www.greyhole.net/releases/deb stable main" > /etc/apt/sources.list.d/greyhole.list
    apt-get update
  fi
  echo "==> Installing Greyhole and PHP dependencies..."
  apt-get install -y --no-install-recommends \
    greyhole \
    php \
    php-mysqlnd \
    php-mbstring
fi

# ---------------------------------------------------------------------------
# 2. Ruby (via rbenv, system-wide)
# ---------------------------------------------------------------------------
if [ ! -d "/usr/local/rbenv" ]; then
  echo "==> Installing rbenv + ruby-build system-wide..."
  git clone https://github.com/rbenv/rbenv.git /usr/local/rbenv
  git clone https://github.com/rbenv/ruby-build.git /usr/local/rbenv/plugins/ruby-build
fi

export RBENV_ROOT="/usr/local/rbenv"
export PATH="$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH"

# Install Ruby if not present
if ! rbenv versions --bare | grep -q "^${RUBY_VERSION}$"; then
  echo "==> Installing Ruby ${RUBY_VERSION} (this takes a few minutes)..."
  rbenv install "$RUBY_VERSION"
fi
rbenv global "$RUBY_VERSION"
rbenv rehash

# Make rbenv available to all users
cat > /etc/profile.d/rbenv.sh <<'RBENV'
export RBENV_ROOT="/usr/local/rbenv"
export PATH="$RBENV_ROOT/bin:$RBENV_ROOT/shims:$PATH"
eval "$(rbenv init - bash)"
RBENV

# Ensure bundler is installed
gem install bundler --no-document 2>/dev/null || true
rbenv rehash

# ---------------------------------------------------------------------------
# 3. Create system user
# ---------------------------------------------------------------------------
if ! id "$APP_USER" &>/dev/null; then
  echo "==> Creating system user '$APP_USER'..."
  useradd --system --create-home --shell /bin/bash --user-group "$APP_USER"
else
  echo "==> User '$APP_USER' already exists (skipping)"
fi

# ---------------------------------------------------------------------------
# 4. Deploy application code
# ---------------------------------------------------------------------------
echo "==> Deploying application to $APP_DIR..."
mkdir -p "$APP_DIR"

if [ -d "$APP_DIR/.git" ]; then
  echo "    Updating existing checkout..."
  cd "$APP_DIR"
  git pull --ff-only || echo "    WARNING: git pull failed, using existing code"
else
  # If we're running from a git checkout, copy it; otherwise clone
  SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
  if [ -d "$SCRIPT_DIR/.git" ]; then
    echo "    Copying from local checkout..."
    rsync -a --exclude='.git' --exclude='tmp' --exclude='log' --exclude='node_modules' \
      "$SCRIPT_DIR/" "$APP_DIR/"
  else
    echo "    Cloning from GitHub..."
    git clone https://github.com/CatDogBark/Amahi-kai.git "$APP_DIR"
  fi
fi

cd "$APP_DIR"
mkdir -p tmp/pids tmp/cache tmp/sockets log
chown -R "$APP_USER:$APP_GROUP" "$APP_DIR"

# ---------------------------------------------------------------------------
# 5. Bundle install
# ---------------------------------------------------------------------------
echo "==> Installing Ruby gems..."
sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && bundle config set --local without 'development test' && bundle install --jobs 4"

# ---------------------------------------------------------------------------
# 6. Create directories
# ---------------------------------------------------------------------------
echo "==> Creating data directories..."
mkdir -p "$SHARE_ROOT"
mkdir -p "$CONFIG_DIR"
mkdir -p /var/hda/dbs
mkdir -p /var/hda/tmp
chown "$APP_USER:$APP_GROUP" /var/hda/tmp

# ---------------------------------------------------------------------------
# 7. Generate config (if not exists)
# ---------------------------------------------------------------------------
if [ ! -f "$ENV_FILE" ]; then
  echo "==> Generating configuration..."
  SECRET=$(openssl rand -hex 32)
  DB_PASS=$(openssl rand -hex 16)
  cat > "$ENV_FILE" <<EOF
# Amahi-kai production configuration
# Generated by bin/amahi-install on $(date -Iseconds)

SECRET_KEY_BASE=$SECRET
RAILS_ENV=production

# Serve static assets from Puma (no nginx reverse proxy in front)
RAILS_SERVE_STATIC_FILES=true

DATABASE_HOST=localhost
DATABASE_NAME=amahi_production
DATABASE_USER=amahi
DATABASE_PASSWORD=$DB_PASS
AMAHI_DUMMY_MODE=false

# Allow access via Cloudflare Tunnel (set to your domain, or remove if not using one)
# RAILS_ALLOWED_HOST=your-domain.example.com

# Share root (default: /var/hda/files)
# AMAHI_SHARE_ROOT=/var/hda/files
EOF
  chmod 640 "$ENV_FILE"
  chown root:"$APP_USER" "$ENV_FILE"
  echo "    Config written to $ENV_FILE"
else
  echo "    Config already exists at $ENV_FILE (skipping)"
  chmod 640 "$ENV_FILE"
  chown root:"$APP_USER" "$ENV_FILE"
fi

# Source the env file for DB setup
set -a
source "$ENV_FILE"
set +a

# ---------------------------------------------------------------------------
# 8. MariaDB setup
# ---------------------------------------------------------------------------
echo "==> Configuring MariaDB..."
systemctl enable --now mariadb

# Create database and user (idempotent)
mysql -u root <<EOSQL || true
CREATE DATABASE IF NOT EXISTS \`${DATABASE_NAME:-amahi_production}\`;
CREATE USER IF NOT EXISTS '${DATABASE_USER:-amahi}'@'localhost' IDENTIFIED BY '${DATABASE_PASSWORD:-amahi}';
GRANT ALL PRIVILEGES ON \`${DATABASE_NAME:-amahi_production}\`.* TO '${DATABASE_USER:-amahi}'@'localhost';
FLUSH PRIVILEGES;
EOSQL

# Greyhole database (if installed)
if $WITH_GREYHOLE; then
  echo "==> Creating Greyhole database..."
  mysql -u root <<EOSQL || true
CREATE DATABASE IF NOT EXISTS greyhole;
GRANT ALL PRIVILEGES ON greyhole.* TO '${DATABASE_USER:-amahi}'@'localhost';
FLUSH PRIVILEGES;
EOSQL
  # Initialize Greyhole schema if available
  if [ -f /usr/share/greyhole/schema-mysql.sql ]; then
    mysql -u root greyhole < /usr/share/greyhole/schema-mysql.sql 2>/dev/null || true
  fi
fi

# ---------------------------------------------------------------------------
# 9. Database migrations
# ---------------------------------------------------------------------------
echo "==> Running database migrations..."
sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails db:migrate"

echo "==> Seeding database..."
sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails db:seed"

# Detect host IP and patch network settings to match this machine
HOST_IP=$(hostname -I | awk '{print $1}')
if [ -n "$HOST_IP" ]; then
  NET_PREFIX=$(echo "$HOST_IP" | cut -d. -f1-3)
  SELF_ADDR=$(echo "$HOST_IP" | cut -d. -f4)
  echo "==> Configuring network settings for $HOST_IP..."
  sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails runner \"
    Setting.set('net', '$NET_PREFIX')
    Setting.set('self-address', '$SELF_ADDR')
  \""
fi

# Headless mode: generate random password and mark setup complete
if $HEADLESS; then
  ADMIN_PASS=$(openssl rand -base64 16 | tr -d '/+=' | head -c 20)
  echo "==> Headless mode: configuring admin account..."
  sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails runner \"
    user = User.find_by(login: 'admin')
    user.password = '$ADMIN_PASS'
    user.password_confirmation = '$ADMIN_PASS'
    user.save!
    Setting.set('setup_completed', 'true')
  \""
fi

# ---------------------------------------------------------------------------
# 10. Asset precompilation
# ---------------------------------------------------------------------------
echo "==> Precompiling assets..."
sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails assets:precompile"

# ---------------------------------------------------------------------------
# 11. Sudoers allowlist
# ---------------------------------------------------------------------------
echo "==> Installing sudoers allowlist..."
cat > /etc/sudoers.d/amahi-kai <<'SUDOERS'
# Amahi-kai — least-privilege sudoers allowlist
# See docs/security/PRIVILEGE-ESCALATION-MITIGATION.md

# User management
amahi ALL=(root) NOPASSWD: /usr/sbin/useradd
amahi ALL=(root) NOPASSWD: /usr/sbin/usermod
amahi ALL=(root) NOPASSWD: /usr/sbin/userdel

# Samba password management
amahi ALL=(root) NOPASSWD: /usr/bin/pdbedit

# File operations — scoped to share and SSH paths
amahi ALL=(root) NOPASSWD: /usr/bin/chmod [0-9]* /var/hda/*
amahi ALL=(root) NOPASSWD: /usr/bin/chmod -R [a-z]* /var/hda/*
amahi ALL=(root) NOPASSWD: /usr/bin/chmod [a-z]* /var/hda/*
amahi ALL=(root) NOPASSWD: /usr/bin/chmod u+rwx\,go-rwx /home/*/.ssh
amahi ALL=(root) NOPASSWD: /usr/bin/chmod u+rw\,go-rwx /home/*/.ssh/authorized_keys
amahi ALL=(root) NOPASSWD: /usr/bin/chown * /var/hda/*
amahi ALL=(root) NOPASSWD: /usr/bin/chown -R * /home/*/.ssh

# Directory creation for shares
amahi ALL=(root) NOPASSWD: /usr/bin/mkdir -p /var/hda/*

# Config file staging
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/amahi-staging/* /etc/samba/*
amahi ALL=(root) NOPASSWD: /usr/bin/cp /tmp/amahi-staging/* /etc/dnsmasq.d/*
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/hda/tmp/* /etc/samba/*
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/hda/tmp/* /etc/dnsmasq.d/*

# Service management — scoped to Amahi-managed services ONLY
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable smbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable nmbd.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable dnsmasq.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable dnsmasq.service

# Database backups
amahi ALL=(root) NOPASSWD: /usr/bin/mysqldump

# Greyhole service management
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl start greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl stop greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl restart greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl reload greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl enable greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl disable greyhole.service
amahi ALL=(root) NOPASSWD: /usr/bin/systemctl status greyhole.service

# Greyhole config management
amahi ALL=(root) NOPASSWD: /usr/bin/cp /var/hda/tmp/* /etc/greyhole.conf

# Greyhole installation (web UI triggered)
amahi ALL=(root) NOPASSWD: /usr/bin/apt-get update
amahi ALL=(root) NOPASSWD: /usr/bin/apt-get install -y greyhole
amahi ALL=(root) NOPASSWD: /usr/bin/gpg --dearmor -o /usr/share/keyrings/greyhole-archive-keyring.gpg
amahi ALL=(root) NOPASSWD: /usr/bin/tee /etc/apt/sources.list.d/greyhole.list
amahi ALL=(root) NOPASSWD: /usr/bin/tee /etc/greyhole.conf
amahi ALL=(root) NOPASSWD: /usr/bin/mysql -u root *
SUDOERS
chmod 440 /etc/sudoers.d/amahi-kai

# Validate
visudo -cf /etc/sudoers.d/amahi-kai
echo "    Sudoers validated OK"

# ---------------------------------------------------------------------------
# 12. Systemd service (with RAILS_LOG_TO_STDOUT)
# ---------------------------------------------------------------------------
echo "==> Installing systemd service..."
cat > /etc/systemd/system/amahi-kai.service <<UNIT
[Unit]
Description=Amahi-kai Home Server (Puma)
After=network.target mariadb.service
Requires=mariadb.service

[Service]
Type=simple
User=$APP_USER
Group=$APP_GROUP
WorkingDirectory=$APP_DIR
EnvironmentFile=$ENV_FILE
Environment=RBENV_ROOT=/usr/local/rbenv
Environment=PATH=/usr/local/rbenv/shims:/usr/local/rbenv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
Environment=RAILS_LOG_TO_STDOUT=true
ExecStart=/usr/local/rbenv/shims/bundle exec puma -C config/puma.rb
Restart=on-failure
RestartSec=5
StandardOutput=journal
StandardError=journal
SyslogIdentifier=amahi-kai

[Install]
WantedBy=multi-user.target
UNIT

systemctl daemon-reload
systemctl enable amahi-kai

# ---------------------------------------------------------------------------
# 13. Firewall — open port 3000 (Puma direct)
# ---------------------------------------------------------------------------
if command -v ufw &>/dev/null && ufw status | grep -q "Status: active"; then
  echo "==> Opening port 3000 in UFW..."
  ufw allow 3000/tcp comment "Amahi-kai web UI (Puma)" || true
fi

# ---------------------------------------------------------------------------
# 14. Enable services (Samba)
# ---------------------------------------------------------------------------
echo "==> Enabling services..."
systemctl enable --now smbd nmbd
# dnsmasq disabled by default — enable when DNS aliases are configured
# systemctl enable --now dnsmasq

# Greyhole (enable but don't start — wizard or user configures drives first)
if $WITH_GREYHOLE && command -v greyhole &>/dev/null; then
  echo "==> Enabling Greyhole service..."
  systemctl enable greyhole || true
fi

# ---------------------------------------------------------------------------
# 15. File search index
# ---------------------------------------------------------------------------
echo "==> Building file search index..."
sudo -u "$APP_USER" bash -lc "set -a && source $ENV_FILE && set +a && cd $APP_DIR && RAILS_ENV=production bin/rails shares:reindex" || true

# Systemd timer for periodic index updates (every 10 minutes)
cat > /etc/systemd/system/amahi-kai-indexer.service <<UNIT
[Unit]
Description=Amahi-kai Share File Indexer
After=amahi-kai.service mariadb.service

[Service]
Type=oneshot
User=$APP_USER
Group=$APP_GROUP
WorkingDirectory=$APP_DIR
EnvironmentFile=$ENV_FILE
Environment=RBENV_ROOT=/usr/local/rbenv
Environment=PATH=/usr/local/rbenv/shims:/usr/local/rbenv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
ExecStart=/usr/local/rbenv/shims/bundle exec rails shares:update_index
StandardOutput=journal
StandardError=journal
SyslogIdentifier=amahi-kai-indexer
UNIT

cat > /etc/systemd/system/amahi-kai-indexer.timer <<TIMER
[Unit]
Description=Amahi-kai Share File Index Update (every 10 min)

[Timer]
OnBootSec=2min
OnUnitActiveSec=10min

[Install]
WantedBy=timers.target
TIMER

systemctl daemon-reload
systemctl enable --now amahi-kai-indexer.timer

# ---------------------------------------------------------------------------
# 16. Start Amahi-kai
# ---------------------------------------------------------------------------
echo "==> Starting Amahi-kai..."
systemctl start amahi-kai

echo ""
echo "============================================"
echo "  Amahi-kai installation complete!"
echo "============================================"
echo ""
echo "  Web UI:  http://$(hostname -I | awk '{print $1}'):3000"
echo "  Tunnel:  (configure Cloudflare Tunnel if needed)"
if $HEADLESS; then
  echo ""
  echo "  ┌─────────────────────────────────────┐"
  echo "  │  ADMIN CREDENTIALS (save these!)    │"
  echo "  │                                     │"
  echo "  │  Username: admin                    │"
  echo "  │  Password: $ADMIN_PASS"
  echo "  │                                     │"
  echo "  │  Setup wizard: SKIPPED (headless)   │"
  echo "  └─────────────────────────────────────┘"
  echo ""
else
  echo "  Login:   admin / secretpassword"
  echo "  NOTE:    The setup wizard will guide you through"
  echo "           initial configuration on first login."
  echo ""
fi
echo "  Config:  $ENV_FILE"
echo "  App:     $APP_DIR"
echo "  Shares:  $SHARE_ROOT"
echo "  Logs:    journalctl -u amahi-kai -f"
echo ""
echo "  Services:"
echo "    systemctl status amahi-kai   # Rails app (Puma on :3000)"
echo "    systemctl status mariadb     # Database"
echo "    systemctl status smbd        # Samba file sharing"
if $WITH_GREYHOLE; then
  echo "    systemctl status greyhole    # Storage pooling"
fi
echo ""

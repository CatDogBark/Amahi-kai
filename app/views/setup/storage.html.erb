<% content_for :progress do %>
  <div class="step done"></div>
  <div class="step done"></div>
  <div class="step done"></div>
  <div class="step current"></div>
  <div class="step"></div>
  <div class="step"></div>
  <div class="step"></div>
<% end %>

<h2>üíæ Storage Drives</h2>
<p>
  Amahi-kai can detect your drives and prepare them for use.
  Select drives to add to your storage pool. <strong>OS drives cannot be selected.</strong>
</p>

<% if @devices.any? { |d| !d[:os_disk] } %>
  <form id="storage-form" onsubmit="prepareDrives(event); return false;">
    <div class="drive-list">
      <% @devices.each do |device| %>
        <% next if device[:os_disk] %>
        <% device[:partitions].each do |part| %>
          <div class="drive-item" style="flex-wrap: wrap;">
            <input type="checkbox" name="drives[]" value="<%= part[:path] %>"
                   id="drive_<%= part[:path].gsub('/', '_') %>"
                   data-status="<%= part[:status] %>"
                   <%= 'checked' if @pool_paths.include?(part[:path]) || @pool_paths.include?(part[:mountpoint]) %>>
            <label for="drive_<%= part[:path].gsub('/', '_') %>" style="display: inline; margin: 0; cursor: pointer; flex: 1;">
              <span class="drive-path"><%= device[:model] %></span>
              <span class="setup-muted" style="font-size: 13px; margin-left: 6px;">
                (<%= part[:path] %>)
              </span>
            </label>
            <span class="drive-size"><%= part[:size] %></span>
            <div style="width: 100%; margin-left: 30px; margin-top: 4px; font-size: 12px;">
              <% case part[:status] %>
              <% when :mounted %>
                <span class="setup-success">‚úì Mounted at <%= part[:mountpoint] %></span>
                <span class="setup-muted" style="margin-left: 8px;"><%= part[:fstype] %></span>
              <% when :unmounted %>
                <% supported_fs = %w[ext2 ext3 ext4 xfs btrfs] %>
                <% fs_supported = supported_fs.include?(part[:fstype].to_s.downcase) %>
                <span class="setup-warning">‚ö† Has existing <%= part[:fstype] %> filesystem (may contain data)</span>
                <a href="#" class="setup-link" style="margin-left: 8px; font-size: 12px;"
                   onclick="previewDrive('<%= part[:path] %>'); return false;">Preview contents</a>
                <div style="margin-top: 4px;">
                  <% unless fs_supported %>
                    <span class="setup-muted" style="font-size: 12px;">
                      üìÇ Will be mounted as a standalone share (not pooled ‚Äî <%= part[:fstype] %> doesn't support Greyhole)
                    </span>
                    <div style="margin-top: 2px;">
                      <label class="setup-danger" style="font-size: 12px; display: inline; cursor: pointer;">
                        <input type="checkbox" name="format_drives[]" value="<%= part[:path] %>" style="margin-right: 4px;"
                               disabled data-requires="drive_<%= part[:path].gsub('/', '_') %>">
                        Format as ext4 instead (erases all data, enables pooling)
                      </label>
                    </div>
                  <% else %>
                    <label class="setup-muted" style="font-size: 12px; display: inline; cursor: pointer;">
                      <input type="checkbox" name="format_drives[]" value="<%= part[:path] %>" style="margin-right: 4px;"
                             disabled data-requires="drive_<%= part[:path].gsub('/', '_') %>">
                      Format as ext4 (erases all data)
                    </label>
                    <span class="setup-hint" style="font-size: 11px; margin-left: 4px;">‚Äî or leave unchecked to mount as-is</span>
                  <% end %>
                </div>
              <% when :unformatted %>
                <span class="setup-danger">‚äò No filesystem ‚Äî will be formatted (ext4) and mounted</span>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>

    <p class="setup-hint" style="font-size: 12px; margin-top: 4px;">
      ‚ö†Ô∏è Formatting a drive erases all data on it. Only unformatted drives will be formatted.
    </p>

    <div class="setup-actions">
      <a href="<%= setup_greyhole_path %>" class="btn-skip">Skip</a>
      <button type="submit" class="btn-kai">Prepare Drives & Continue ‚Üí</button>
    </div>
  </form>
<% else %>
  <div class="setup-muted" style="text-align: center; padding: 20px;">
    <p>No additional drives detected beyond your OS disk.</p>
    <p style="font-size: 13px;">You can add drives later from the Shares settings.</p>
  </div>
  <div class="setup-actions">
    <div></div>
    <a href="<%= setup_greyhole_path %>" class="btn-kai">Continue ‚Üí</a>
  </div>
<% end %>

<%= render 'shared/install_terminal', id: 'prepare-drives', title: 'Preparing Drives', stream_url: '' %>

<!-- Drive Preview Modal -->
<div id="preview-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:1000; display:none; align-items:center; justify-content:center;">
  <div style="background:#fff; border-radius:12px; max-width:500px; width:90%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.4);">
    <div style="padding:16px 20px; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
      <strong id="preview-title">üìÇ Drive Preview</strong>
      <a href="#" onclick="closePreview(); return false;" style="color:#9ca3af; text-decoration:none; font-size:20px;">‚úï</a>
    </div>
    <div id="preview-body" style="padding:16px 20px;">
      <div style="text-align:center; padding:20px; color:#7f8c9b;">Loading...</div>
    </div>
  </div>
</div>

<style>
  @keyframes spin { to { transform: rotate(360deg); } }
  @media (prefers-color-scheme: dark) {
    #preview-modal > div { background: #161b22 !important; }
    #preview-modal > div > div:first-child { border-bottom-color: #30363d !important; }
    #preview-modal strong { color: #e6edf3; }
    #preview-modal .preview-entry { border-bottom-color: #21262d !important; color: #c9d1d9; }
    #preview-modal .preview-size { color: #8b949e !important; }
  }
</style>

<script>
function prepareDrives(event) {
  event.preventDefault();

  var drives = [];
  var formatDrives = [];
  document.querySelectorAll('input[name="drives[]"]:checked').forEach(function(cb) {
    drives.push(cb.value);
  });
  document.querySelectorAll('input[name="format_drives[]"]:checked').forEach(function(cb) {
    formatDrives.push(cb.value);
  });

  if (drives.length === 0) {
    window.location.href = '<%= setup_greyhole_path %>';
    return;
  }

  var url = '<%= setup_prepare_drives_stream_path %>'
    + '?drives=' + encodeURIComponent(drives.join(','))
    + '&format_drives=' + encodeURIComponent(formatDrives.join(','));

  var id = 'prepare-drives';
  var modal = document.getElementById(id + '-install-modal');
  var output = document.getElementById(id + '-output');
  var cursor = document.getElementById(id + '-cursor');
  var footer = document.getElementById(id + '-install-footer');
  var terminal = document.getElementById(id + '-terminal');

  modal.style.display = 'flex';
  output.innerHTML = '';
  cursor.style.display = '';
  footer.style.display = 'none';
  footer.innerHTML = '<a href="<%= setup_greyhole_path %>" class="btn btn-sm btn-outline-light">Continue ‚Üí</a>';

  var source = new EventSource(url);

  source.onmessage = function(e) {
    var line = document.createElement('div');
    line.className = 'term-line';
    var text = e.data;
    if (text.match(/^(Formatting|Mounting|Preparing)/)) { line.classList.add('step'); }
    else if (text.match(/‚úì/)) { line.classList.add('success'); }
    else if (text.match(/‚úó/)) { line.classList.add('error'); }
    else if (text.match(/‚ö†/)) { line.classList.add('warn'); }
    line.textContent = text;
    output.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  };

  source.addEventListener('done', function(e) {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
  });

  source.onerror = function() {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
    var line = document.createElement('div');
    line.className = 'term-line error';
    line.textContent = '‚úó Connection lost';
    output.appendChild(line);
  };
}
</script>

<script>
  function previewDrive(device) {
    var modal = document.getElementById('preview-modal');
    var body = document.getElementById('preview-body');
    var title = document.getElementById('preview-title');
    modal.style.display = 'flex';
    body.innerHTML = '<div style="text-align:center;padding:20px;color:#7f8c9b;"><span style="display:inline-block;width:16px;height:16px;border:2px solid rgba(127,140,155,0.3);border-top-color:#7f8c9b;border-radius:50%;animation:spin 0.8s linear infinite;vertical-align:middle;margin-right:8px;"></span>Mounting and reading drive...</div>';
    title.textContent = 'üìÇ Preview: ' + device;

    var token = document.querySelector('meta[name="csrf-token"]');
    fetch('<%= setup_preview_drive_path %>', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': token ? token.content : '' },
      body: JSON.stringify({ device: device })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.status === 'error') {
        body.innerHTML = '<div style="color:#ef4444;padding:10px;">' + data.message + '</div>';
        return;
      }
      var html = '<div style="margin-bottom:12px;font-size:13px;color:#7f8c9b;">' +
        formatSize(data.total_used) + ' used ¬∑ ' + data.file_count + ' file' + (data.file_count === 1 ? '' : 's') + '</div>';

      if (data.entries.length === 0) {
        html += '<div style="color:#7f8c9b;">Drive is empty.</div>';
      } else {
        data.entries.forEach(function(e) {
          var icon = e.type === 'directory' ? 'üìÅ' : 'üìÑ';
          var name = e.type === 'directory' ? '<strong>' + e.name + '</strong>' : e.name;
          var info = formatSize(e.size);
          if (e.type === 'directory' && e.file_count !== undefined) info += ' ¬∑ ' + e.file_count + ' files';
          html += '<div class="preview-entry" style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f5f9;font-size:14px;">' +
            '<span>' + icon + ' ' + name + '</span>' +
            '<span class="preview-size" style="color:#7f8c9b;font-size:13px;">' + info + '</span></div>';
        });
      }
      body.innerHTML = html;
    })
    .catch(function(err) {
      body.innerHTML = '<div style="color:#ef4444;padding:10px;">Failed to preview drive: ' + err.message + '</div>';
    });
  }

  function closePreview() {
    document.getElementById('preview-modal').style.display = 'none';
  }

  function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    var units = ['B', 'KB', 'MB', 'GB', 'TB'];
    var i = Math.floor(Math.log(bytes) / Math.log(1024));
    return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
  }

  // Close modal on backdrop click
  document.getElementById('preview-modal').addEventListener('click', function(e) {
    if (e.target === this) closePreview();
  });

  // Enable/disable format checkbox based on drive selection
  document.querySelectorAll('input[name="drives[]"]').forEach(function(driveBox) {
    driveBox.addEventListener('change', function() {
      document.querySelectorAll('[data-requires="' + this.id + '"]').forEach(function(formatBox) {
        formatBox.disabled = !driveBox.checked;
        if (!driveBox.checked) formatBox.checked = false;
      });
    });
  });
</script>

<div class="container-fluid">
  <% if @security_blockers.any? %>
    <div class="alert alert-danger d-flex align-items-center mb-4" role="alert">
      âš  
      <div>
        <strong>Security issues must be fixed before enabling remote access.</strong><br>
        <%= @security_blockers.size %> blocker<%= @security_blockers.size == 1 ? '' : 's' %> found â€”
        <a href="#" class="alert-link" onclick="runSecurityAudit(); return false;">Run security audit</a>
        or <a href="<%= security_index_path %>" class="alert-link">go to Security tab</a>
      </div>
    </div>
  <% end %>

  <!-- Cloudflare Tunnel Status -->
  <div class="card mb-4 mt-3">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0"><%= lucide_icon('cloud', size: 18) %> Cloudflare Tunnel</h5>
      <% if @tunnel_status[:installed] && @tunnel_status[:running] %>
        <span class="badge bg-success">Connected</span>
      <% elsif @tunnel_status[:installed] %>
        <span class="badge bg-warning text-dark">Stopped</span>
      <% else %>
        <span class="badge bg-secondary">Not Installed</span>
      <% end %>
    </div>
    <div class="card-body">
      <% if !@tunnel_status[:installed] || !@tunnel_status[:token_configured] %>
        <!-- Not installed or not configured â€” show setup instructions + token input -->
        <p class="text-muted mb-3">Cloudflare Tunnel lets you securely access your Amahi server from anywhere â€” no port forwarding needed.</p>

        <div class="card bg-light mb-3">
          <div class="card-body">
            <h6 class="card-title">Setup Instructions</h6>
            <p class="text-muted small mb-3">Cloudflare Tunnel creates a secure connection from your server to Cloudflare's network â€” no port forwarding, no exposed ports, no dynamic DNS.</p>

            <h6>Step 1: Create a Cloudflare account</h6>
            <ol class="mb-3">
              <li>Sign up at <a href="https://dash.cloudflare.com" target="_blank" rel="noopener">dash.cloudflare.com</a> (the free plan works)</li>
              <li>Add your domain â€” go to <strong>Websites</strong> â†’ <strong>Add a site</strong></li>
              <li>Follow Cloudflare's instructions to update your domain's nameservers at your registrar (e.g., Namecheap, GoDaddy)</li>
              <li>Wait for DNS to propagate (can take a few minutes to 24 hours)</li>
            </ol>

            <h6>Step 2: Create a tunnel</h6>
            <ol class="mb-3">
              <li>Go to <strong>Zero Trust</strong> (left sidebar) â†’ <strong>Networks</strong> â†’ <strong>Tunnels</strong></li>
              <li>Click <strong>Create a tunnel</strong></li>
              <li>Select tunnel type: <strong>Cloudflared</strong></li>
              <li>Name your tunnel (e.g., "amahi-kai" or "home-server")</li>
              <li>On the <strong>Install and run connectors</strong> page, find the tunnel token â€” it's the long string after <code>--token</code> in the install command</li>
              <li><strong>Don't run their install command</strong> â€” just copy the token</li>
            </ol>

            <h6>Step 3: Route traffic (Published applications)</h6>
            <ol class="mb-3">
              <li>On the <strong>Route tunnel</strong> step, go to the <strong>Published applications</strong> tab</li>
              <li>Set the <strong>Subdomain</strong> (e.g., <code>nas</code>) and select your <strong>Domain</strong></li>
              <li>Leave <strong>Path</strong> empty (matches all paths)</li>
              <li>Under <strong>Service</strong>, set Type to <strong>HTTP</strong> and URL to <strong>localhost:3000</strong></li>
              <li>Click <strong>Save</strong></li>
              <li>Cloudflare will automatically create the DNS record for you</li>
            </ol>

            <h6>Step 4: Paste your token and connect</h6>
            <p class="text-muted small">We'll install cloudflared (if needed), configure the tunnel, and start the connection â€” all in one step.</p>
          </div>
        </div>

        <div class="d-flex gap-2" id="tunnel-token-input">
          <input type="text" id="tunnel-token-field" class="form-control" placeholder="Paste your Cloudflare Tunnel token here" style="font-family:monospace; font-size:0.85rem;">
          <button type="button" class="btn btn-primary text-nowrap" onclick="setupTunnel()">
            Connect
          </button>
        </div>

      <% else %>
        <!-- Configured -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="p-3 border rounded">
              <small class="text-muted d-block">Status</small>
              <strong><%= @tunnel_status[:running] ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Disconnected' %></strong>
            </div>
          </div>
          <% if @tunnel_status[:tunnel_url] %>
            <div class="col-md-6">
              <div class="p-3 border rounded">
                <small class="text-muted d-block">Tunnel URL</small>
                <a href="<%= @tunnel_status[:tunnel_url] %>" target="_blank" rel="noopener"><%= @tunnel_status[:tunnel_url] %></a>
              </div>
            </div>
          <% end %>
          <% if @tunnel_status[:connected_since] %>
            <div class="col-md-6">
              <div class="p-3 border rounded">
                <small class="text-muted d-block">Connected Since</small>
                <strong><%= @tunnel_status[:connected_since] %></strong>
              </div>
            </div>
          <% end %>
        </div>

        <div class="d-flex gap-2">
          <% if @tunnel_status[:running] %>
            <button type="button" class="btn btn-outline-danger" onclick="tunnelAction('stop')">
              Disconnect
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="tunnelAction('restart')">
              Restart
            </button>
          <% else %>
            <button type="button" class="btn btn-success" onclick="tunnelAction('start')">
              Connect
            </button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Tailscale VPN -->
  <div class="card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between">
      <h5 class="mb-0"><%= lucide_icon('shield', size: 18) %> Tailscale VPN</h5>
      <% if @tailscale_status[:running] %>
        <span class="badge bg-success">Connected</span>
      <% elsif @tailscale_status[:installed] %>
        <span class="badge bg-warning text-dark">Stopped</span>
      <% else %>
        <span class="badge bg-secondary">Not Installed</span>
      <% end %>
    </div>
    <div class="card-body">
      <% if !@tailscale_status[:installed] %>
        <p class="text-muted mb-3">
          Tailscale is a mesh VPN â€” access your NAS from anywhere with <strong>no domain, no port forwarding, and no configuration</strong>.
          Just install, authenticate with your Tailscale account, and your devices are connected.
        </p>

        <div class="card bg-light mb-3">
          <div class="card-body">
            <h6 class="card-title">How it works</h6>
            <ol class="mb-0">
              <li>Create a free account at <a href="https://tailscale.com" target="_blank" rel="noopener">tailscale.com</a></li>
              <li>Click <strong>Install Tailscale</strong> below â€” we'll install and start the service</li>
              <li>Click the authentication link that appears to add this device to your Tailnet</li>
              <li>Install Tailscale on your phone/laptop â€” they'll see your NAS automatically</li>
            </ol>
          </div>
        </div>

        <button type="button" class="btn btn-primary" onclick="installTailscale()">
          <%= lucide_icon('download', size: 16) %> Install Tailscale
        </button>

      <% elsif @tailscale_status[:running] %>
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <div class="p-3 border rounded">
              <small class="text-muted d-block">Status</small>
              <strong>ðŸŸ¢ Connected</strong>
            </div>
          </div>
          <% if @tailscale_status[:tailscale_ip] %>
            <div class="col-md-4">
              <div class="p-3 border rounded">
                <small class="text-muted d-block">Tailscale IP</small>
                <strong><code><%= @tailscale_status[:tailscale_ip] %></code></strong>
              </div>
            </div>
          <% end %>
          <% if @tailscale_status[:magic_dns] %>
            <div class="col-md-4">
              <div class="p-3 border rounded">
                <small class="text-muted d-block">MagicDNS</small>
                <strong><code><%= @tailscale_status[:magic_dns] %></code></strong>
              </div>
            </div>
          <% end %>
          <% if @tailscale_status[:peers] && @tailscale_status[:peers] > 0 %>
            <div class="col-md-4">
              <div class="p-3 border rounded">
                <small class="text-muted d-block">Peers</small>
                <strong><%= @tailscale_status[:peers] %> device<%= @tailscale_status[:peers] == 1 ? '' : 's' %></strong>
              </div>
            </div>
          <% end %>
        </div>

        <p class="text-muted small mb-3">
          Access your NAS at <strong>http://<%= @tailscale_status[:tailscale_ip] %>:3000</strong>
          <% if @tailscale_status[:magic_dns] %>
            or <strong>http://<%= @tailscale_status[:magic_dns] %>:3000</strong>
          <% end %>
          from any device on your Tailnet.
        </p>

        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-danger btn-sm" onclick="tailscaleAction('stop')">
            Disconnect
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="if(confirm('This will remove this device from your Tailnet. Continue?')) tailscaleAction('logout')">
            Logout & Remove
          </button>
        </div>

      <% else %>
        <!-- Installed but not running -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <div class="p-3 border rounded">
              <small class="text-muted d-block">Status</small>
              <strong>ðŸ”´ Disconnected</strong>
            </div>
          </div>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-success btn-sm" onclick="startTailscale()">
            Connect
          </button>
          <button type="button" class="btn btn-outline-secondary btn-sm" onclick="if(confirm('This will remove this device from your Tailnet. Continue?')) tailscaleAction('logout')">
            Logout & Remove
          </button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= render 'shared/install_terminal', id: 'tunnel-setup', title: 'Setting up Cloudflare Tunnel', stream_url: '' %>
<%= render 'shared/install_terminal', id: 'tailscale-install', title: 'Installing Tailscale', stream_url: remote_access_install_tailscale_stream_path %>
<%= render 'shared/install_terminal', id: 'security-audit', title: 'Security Audit', stream_url: security_audit_stream_path %>
<%= render 'shared/install_terminal', id: 'security-fix', title: 'Applying Security Fixes', stream_url: security_fix_stream_path %>

<script>
function setupTunnel() {
  var token = document.getElementById('tunnel-token-field').value.trim();
  if (!token) { alert('Please paste your tunnel token first.'); return; }
  var url = '<%= remote_access_setup_tunnel_stream_path %>' + '?token=' + encodeURIComponent(token);
  openInstallTerminal('tunnel-setup', url);
}

function runSecurityAudit() {
  var id = 'security-audit';
  var url = '<%= security_audit_stream_path %>';
  var modal = document.getElementById(id + '-install-modal');
  var output = document.getElementById(id + '-output');
  var cursor = document.getElementById(id + '-cursor');
  var footer = document.getElementById(id + '-install-footer');
  var terminal = document.getElementById(id + '-terminal');

  modal.style.display = 'flex';
  output.innerHTML = '';
  cursor.style.display = '';
  footer.style.display = 'none';
  footer.innerHTML = '<button type="button" class="btn btn-sm btn-outline-light" onclick="closeInstallTerminal(\'security-audit\')">Close & Refresh</button>';

  var source = new EventSource(url);

  source.onmessage = function(e) {
    var line = document.createElement('div');
    line.className = 'term-line';
    var text = e.data;
    if (text.match(/^(Checking|Running)/)) { line.classList.add('step'); }
    else if (text.match(/^  âœ“/)) { line.classList.add('success'); }
    else if (text.match(/^  âœ—/) || text.match(/^âœ—/)) { line.classList.add('error'); }
    else if (text.match(/^  âš /) || text.match(/^âš /)) { line.classList.add('warn'); }
    else if (text.match(/^â”€â”€â”€/)) { line.style.color = '#7f8c9b'; line.style.fontWeight = 'bold'; line.style.marginTop = '8px'; }
    line.textContent = text;
    output.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  };

  source.addEventListener('has_fixable', function(e) {
    if (e.data === 'true') {
      var fixBtn = document.createElement('button');
      fixBtn.type = 'button';
      fixBtn.className = 'btn btn-sm btn-warning me-2';
      fixBtn.innerHTML = 'Fix All Issues';
      fixBtn.onclick = function() {
        document.getElementById('security-audit-install-modal').style.display = 'none';
        openInstallTerminal('security-fix', '<%= security_fix_stream_path %>');
      };
      footer.insertBefore(fixBtn, footer.firstChild);
    }
  });

  source.addEventListener('done', function(e) {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
  });

  source.onerror = function() {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
    var line = document.createElement('div');
    line.className = 'term-line error';
    line.textContent = 'âœ— Connection lost';
    output.appendChild(line);
  };
}

function installTailscale() {
  var id = 'tailscale-install';
  var url = '<%= remote_access_install_tailscale_stream_path %>';
  var modal = document.getElementById(id + '-install-modal');
  var output = document.getElementById(id + '-output');
  var cursor = document.getElementById(id + '-cursor');
  var footer = document.getElementById(id + '-install-footer');
  var terminal = document.getElementById(id + '-terminal');

  modal.style.display = 'flex';
  output.innerHTML = '';
  cursor.style.display = '';
  footer.style.display = 'none';
  footer.innerHTML = '<button type="button" class="btn btn-sm btn-outline-light" onclick="closeInstallTerminal(\'' + id + '\')">Close & Refresh</button>';

  var source = new EventSource(url);

  source.onmessage = function(e) {
    var line = document.createElement('div');
    line.className = 'term-line';
    var text = e.data;
    if (text.match(/^(Installing|Starting|Downloading)/)) { line.classList.add('step'); }
    else if (text.match(/âœ“/)) { line.classList.add('success'); }
    else if (text.match(/âœ—/)) { line.classList.add('error'); }
    else if (text.match(/âš /)) { line.classList.add('warn'); }
    line.textContent = text;
    output.appendChild(line);
    terminal.scrollTop = terminal.scrollHeight;
  };

  source.addEventListener('auth_url', function(e) {
    if (e.data) {
      var linkDiv = document.createElement('div');
      linkDiv.className = 'term-line';
      linkDiv.style.marginTop = '8px';
      linkDiv.innerHTML = '<a href="' + e.data + '" target="_blank" rel="noopener" style="color:#4fc3f7;text-decoration:underline;font-weight:bold;">â†’ Click here to authenticate with Tailscale</a>';
      output.appendChild(linkDiv);
      terminal.scrollTop = terminal.scrollHeight;
    }
  });

  source.addEventListener('done', function(e) {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
  });

  source.onerror = function() {
    source.close();
    cursor.style.display = 'none';
    footer.style.display = 'block';
  };
}

function startTailscale() {
  var btn = event.target;
  btn.disabled = true;
  btn.textContent = 'Connecting...';
  fetch('<%= remote_access_start_tailscale_path %>', {
    method: 'POST',
    headers: {
      'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content,
      'Accept': 'application/json'
    }
  }).then(function(r) {
    if (!r.ok) throw new Error('Server returned ' + r.status);
    return r.json();
  }).then(function(data) {
    if (data.auth_url) {
      window.open(data.auth_url, '_blank');
      setTimeout(function() { window.location.reload(); }, 5000);
    } else {
      window.location.reload();
    }
  }).catch(function(err) {
    alert('Failed to connect: ' + err.message);
    btn.disabled = false;
    btn.textContent = 'Connect';
  });
}

function tailscaleAction(action) {
  var urls = {
    stop: '<%= remote_access_stop_tailscale_path %>',
    logout: '<%= remote_access_logout_tailscale_path %>'
  };
  fetch(urls[action], {
    method: 'POST',
    headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content }
  }).then(function() { window.location.reload(); });
}

function tunnelAction(action) {
  var urls = {
    start: '<%= remote_access_start_tunnel_path %>',
    stop: '<%= remote_access_stop_tunnel_path %>',
    restart: '<%= remote_access_start_tunnel_path %>'
  };
  fetch(urls[action], {
    method: 'POST',
    headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]').content }
  }).then(function(r) {
    if (!r.ok) throw new Error('Server returned ' + r.status);
    window.location.reload();
  }).catch(function(err) {
    alert('Failed to ' + action + ' tunnel: ' + err.message);
  });
}
</script>

<!DOCTYPE html>
<html dir="<%= @locale_direction %>" lang="<%= I18n.locale %>">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amahi-kai Setup</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="alternate icon" href="/favicon.ico">
  <%= stylesheet_link_tag "login" %>
  <%= stylesheet_link_tag "ocean-bg" %>
  <%= csrf_meta_tags %>
  <style>
    body.setup {
      border-top-color: #1a2332;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .setup-container {
      width: 100%;
      max-width: 640px;
      background: rgba(255,255,255,0.97);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .setup-header {
      background: linear-gradient(135deg, #0a6e8a 0%, #0d8aa8 100%);
      padding: 28px 32px 20px;
      color: white;
    }
    .setup-header h1 {
      font-size: 22px;
      font-weight: 700;
      margin: 0 0 4px;
    }
    .setup-header p {
      margin: 0;
      opacity: 0.85;
      font-size: 14px;
    }
    .setup-progress {
      display: flex;
      gap: 4px;
      padding: 0 32px;
      margin-top: -6px;
    }
    .setup-progress .step {
      flex: 1;
      height: 4px;
      border-radius: 2px;
      background: rgba(255,255,255,0.3);
    }
    .setup-progress .step.done {
      background: #f0a030;
    }
    .setup-progress .step.current {
      background: #f0a030;
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .setup-body {
      padding: 28px 32px 32px;
    }
    .setup-body h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1a2332;
      margin: 0 0 16px;
    }
    .setup-body p {
      color: #4a5568;
      font-size: 14px;
      line-height: 1.6;
      margin: 0 0 16px;
    }
    .setup-body label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 6px;
    }
    .setup-body input[type="text"],
    .setup-body input[type="password"] {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
      box-sizing: border-box;
      transition: border-color 0.2s;
    }
    .setup-body input:focus {
      outline: none;
      border-color: #0d8aa8;
      box-shadow: 0 0 0 3px rgba(13,138,168,0.15);
    }
    .btn-kai {
      display: inline-block;
      padding: 10px 28px;
      background: linear-gradient(135deg, #0a6e8a, #0d8aa8);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .btn-kai:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(10,110,138,0.3);
      color: white;
    }
    .btn-skip {
      display: inline-block;
      padding: 10px 20px;
      color: #7f8c9b;
      background: none;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      margin-left: 8px;
    }
    .btn-skip:hover {
      border-color: #9ca3af;
      color: #4a5568;
    }
    .setup-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 24px;
    }
    /* Toast styles (inline for setup layout) */
    #toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1090;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
      max-width: 420px;
      width: calc(100% - 2rem);
    }
    .amahi-toast {
      display: flex;
      align-items: center;
      gap: 0.65rem;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3), 0 1px 4px rgba(0,0,0,0.2);
      font-size: 0.9rem;
      line-height: 1.4;
      pointer-events: auto;
      cursor: default;
      transform: translateX(calc(100% + 1rem));
      opacity: 0;
      transition: transform 0.3s cubic-bezier(0.22,1,0.36,1), opacity 0.3s ease;
    }
    .amahi-toast-visible { transform: translateX(0); opacity: 1; }
    .amahi-toast-leaving { transform: translateX(calc(100% + 1rem)); opacity: 0; }
    .amahi-toast-icon { font-size: 1.1rem; font-weight: bold; flex-shrink: 0; width: 1.5rem; text-align: center; }
    .amahi-toast-text { flex: 1; word-break: break-word; }
    .amahi-toast-close {
      background: none; border: none; font-size: 1.3rem; line-height: 1;
      opacity: 0.7; cursor: pointer; padding: 0 0.25rem; flex-shrink: 0;
    }
    .amahi-toast-close:hover { opacity: 1; }
    .drive-list {
      margin: 12px 0;
    }
    .drive-item {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .drive-item input[type="checkbox"] {
      margin-right: 12px;
      width: 18px;
      height: 18px;
    }
    .drive-item .drive-path { font-weight: 600; color: #1a2332; }
    .drive-item .drive-size { color: #7f8c9b; margin-left: auto; }
    .summary-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
    }
    .summary-item .check { color: #10b981; margin-right: 10px; font-size: 18px; }
    .summary-item .skip { color: #9ca3af; margin-right: 10px; font-size: 18px; }

    /* ── Dark mode ── */
    @media (prefers-color-scheme: dark) {
      body.setup { background: transparent; }
      .setup-container { background: rgba(22, 27, 34, 0.9); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
      .setup-body h2 { color: #e6edf3; }
      .setup-body p { color: #8b949e; }
      .setup-body label { color: #c9d1d9; }
      .setup-body input[type="text"],
      .setup-body input[type="password"] {
        background: #0d1117;
        border-color: #30363d;
        color: #e6edf3;
      }
      .setup-body input:focus { border-color: #0d8aa8; box-shadow: 0 0 0 3px rgba(13,138,168,0.25); }
      .btn-skip { color: #8b949e; border-color: #30363d; }
      .btn-skip:hover { color: #c9d1d9; border-color: #484f58; }
      .drive-item { background: #0d1117; border-color: #30363d; }
      .drive-item .drive-path { color: #e6edf3; }
      .drive-item .drive-size { color: #8b949e; }
      .summary-item { border-bottom-color: #21262d; color: #c9d1d9; }
      /* old flash classes removed — using toasts now */
    }
  </style>
</head>
<body class="login setup" data-turbo="false">
  <%= render 'layouts/ocean_bg' %>
  <div class="setup-container">
    <div class="setup-header">
      <h1 style="display: flex; align-items: center; gap: 10px;">
        <img src="/favicon.svg" alt="Amahi-kai" style="height: 36px; width: 36px;">
        <span style="font-family: 'Segoe UI', system-ui, sans-serif; letter-spacing: -0.5px;">Amahi<span style="color: #7dd3e8;">-kai</span></span>
      </h1>
      <p>First-run setup</p>
    </div>
    <% if content_for?(:progress) %>
      <div class="setup-progress" style="margin-top: -12px; padding-bottom: 0;">
        <%= yield :progress %>
      </div>
    <% end %>
    <div class="setup-body">
      <% # Flash messages rendered as toasts via inline JS below %>
      <%= yield %>
    </div>
  </div>
<script>
// Inline toast system for setup layout
(function() {
  var TYPE_MAP = {
    success: { bg: '#198754', icon: '✓' },
    notice:  { bg: '#198754', icon: '✓' },
    danger:  { bg: '#dc3545', icon: '✗' },
    error:   { bg: '#dc3545', icon: '✗' },
    warning: { bg: '#ffc107', icon: '⚠', dark: true },
    info:    { bg: '#0dcaf0', icon: 'ℹ', dark: true }
  };
  function getContainer() {
    var c = document.getElementById('toast-container');
    if (!c) { c = document.createElement('div'); c.id = 'toast-container'; document.body.appendChild(c); }
    return c;
  }
  function showToast(message, type) {
    var cfg = TYPE_MAP[type || 'info'] || TYPE_MAP.info;
    var container = getContainer();
    var t = document.createElement('div');
    t.className = 'amahi-toast';
    t.style.cssText = 'background:' + cfg.bg + ';color:' + (cfg.dark ? '#212529' : '#fff') + ';';
    t.innerHTML = '<span class="amahi-toast-icon">' + cfg.icon + '</span><span class="amahi-toast-text">' +
      message.replace(/</g,'&lt;') + '</span><button class="amahi-toast-close" style="color:' +
      (cfg.dark ? '#212529' : '#fff') + '">&times;</button>';
    t.querySelector('.amahi-toast-close').onclick = function() { dismiss(t); };
    container.appendChild(t);
    requestAnimationFrame(function() { requestAnimationFrame(function() { t.classList.add('amahi-toast-visible'); }); });
    var timer = setTimeout(function() { dismiss(t); }, 5000);
    t._timer = timer;
    t.addEventListener('mouseenter', function() { clearTimeout(t._timer); });
    t.addEventListener('mouseleave', function() { t._timer = setTimeout(function() { dismiss(t); }, 2000); });
  }
  function dismiss(t) {
    if (t._gone) return; t._gone = true; clearTimeout(t._timer);
    t.classList.remove('amahi-toast-visible'); t.classList.add('amahi-toast-leaving');
    setTimeout(function() { if (t.parentNode) t.parentNode.removeChild(t); }, 300);
  }
  window.showToast = showToast;
  <% flash.each do |name, msg| %>
    showToast(<%= msg.to_json %>, <%= name.to_json %>);
  <% end %>
})();
</script>
</body>
</html>

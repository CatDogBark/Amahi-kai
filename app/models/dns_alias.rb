# Amahi Home Server
# Copyright (C) 2007-2013 Amahi
#
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License v3
# (29 June 2007), as published in the COPYING file.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# file COPYING for more details.
#
# You should have received a copy of the GNU General Public
# License along with this program; if not, write to the Amahi
# team at http://www.amahi.org/ under "Contact Us."

class DnsAlias < ApplicationRecord

	after_create :restart
	after_destroy :restart
	after_save :restart

	scope :user_visible,->{where(["address != ?", ''])}

	validates :name, presence: true, uniqueness: true, format: { with: /\A[a-z][a-z0-9-]*\z/i }
	# FIXME: validate this OR simply empty to point to our own address
	#validates :address, presence: true, uniqueness: true, numericality: { greater_than: 0, less_than: 255 }

	protected

	def restart
		regenerate_dnsmasq_config
		reload_dnsmasq
	end

	private

	# Generate /etc/dnsmasq.d/amahi-aliases.conf from all dns_aliases
	def regenerate_dnsmasq_config
		# Build config lines: address=/name/address (or address=/name/ for self)
		lines = ["# Auto-generated by Amahi-kai â€” do not edit manually"]
		DnsAlias.all.each do |a|
			if a.address.present?
				lines << "address=/#{a.name}/#{a.address}"
			else
				# Empty address means point to this server's own IP
				lines << "address=/#{a.name}/"
			end
		end

		# Write to a temp file, then move into place via Command (needs sudo)
		require 'tempfile'
		tmp = TempCache.unique_filename("dnsmasq-aliases")
		File.write(tmp, lines.join("\n") + "\n")

		c = Command.new("cp #{Shellwords.escape(tmp)} /etc/dnsmasq.d/amahi-aliases.conf")
		c.submit("chmod 644 /etc/dnsmasq.d/amahi-aliases.conf")
		c.execute
	end

	def reload_dnsmasq
		c = Command.new("systemctl reload dnsmasq.service")
		c.execute
	end

end

# 2026-02-25 — Test Coverage Push & Quality Audit

## What happened
- Troy shared CI results throughout the session, we iterated on specs
- Started at ~19% CI coverage, pushed to ~44% with new specs
- Wrote specs for: share model (extended), user model, server model, docker_app model, application_helper, shares_helper, tabs_helper, setting model (extended), front_controller (toggle_advanced), settings_controller (system_status, themes), search controller (extended), application_controller (locale, auth, setup redirect), full integration flows
- **Quality audit**: Removed all `rescue nil` specs, `be_in([200,400,422,500])` assertions, and `.or eq()` patterns
- Deleted weak spec files: share_controller_extended, disks_controller_extended, users_controller_extended
- Key learning: ShareController renders `share/access` partials that don't resolve in test (they're at `shares/` in plugins) — this is likely a real bug or dead code
- Fixed real bug: full_flows_spec visible toggle (nil default on visible column)
- Found real bug: `Setting.set_kind` has typo (`s.update_attribute!` should be `setting.update_attribute!`)

## Commits (approx 12 commits this session)
- Multiple rounds of spec additions and fixes
- Final audit commit: removed all weak patterns, clean specs only

## Coverage numbers through the session
- Start: 19% (CI), 41.81% (request specs only)
- Peak: 44.36% (1338/3016)
- After audit: slightly lower but all meaningful tests

## Lessons learned
- Writing specs blind (no ability to run locally) means lots of CI round-trips
- `rescue nil` in specs is lying — always test what you can actually assert
- `be_in([200, 400, 422, 500])` asserts nothing useful
- Plugin view partials don't resolve in test for the main ShareController — test model logic instead
- Setting kinds are strings ("general", "network", "shares") not integers
- Protected methods need `send(:method_name)` in specs
- Command class is dummy mode in test env — no need to stub

## Bug Fixes (real code, not just specs)
1. **ShareController 26 broken partial renders** — controller rendered `share/access`, `share/visible`, etc. but partials live at `shares/` in plugin. Fixed to use correct plugin paths or JSON responses. These would 500 in production on any toggle action.
2. **Setting.set_kind typo** — `s.update_attribute!` → `setting.update_attribute!`
3. **Locale cleanup** — 185 amahi.org URLs replaced across 25 locale files. Bulk sed broke YAML quoting (unescaped `"` inside double-quoted strings) — had to fix with second pass.
4. **full_flows_spec visible toggle** — Share `visible` column has no default (nil), toggling `!nil` = true not false.

## v0.1.1 Tagged & Released
- Tag pushed to GitHub by Troy
- Release notes written covering: bug fixes, test coverage, locale/branding, wiki, codebase cleanup, security
- 30 commits since v0.1.0

## TODO Status
- Updated TODO.md (gitignored, local only)
- Rack-attack already implemented from earlier session — login throttling + auto-ban
- Remaining P0: App catalog verification, SSL/force_ssl, Auth modernization
- Troy's take: rate limiting still good OOB even with Cloudflare 2FA since not everyone will configure Access policies

## Session Pattern
- Troy active 05:00-08:15 UTC, sharing CI screenshots iteratively
- ~20 CI round-trips to get specs green (blind spec writing without local rspec)
- Troy pushed back on spec quality mid-session — led to the audit that found 3 real bugs

## Auth Modernization (08:35-08:55 UTC)
- Replaced Authlogic + SCrypt with `has_secure_password` (bcrypt, Rails built-in)
- Removed 2 gems (authlogic, scrypt)
- UserSession rewritten as plain Ruby class with ActiveModel (~60 lines)
- DB migration: crypted_password/password_salt/persistence_token → password_digest
- Bug: forgot to update db/schema.rb (CI uses schema:load not migrate) — 242 failures, fixed
- Bug: used `@errors` instead of `errors` method in UserSession#save — 5 failures, fixed
- CI green after 3 commits
- Also added `config.assume_ssl = true` for Cloudflare Tunnel HTTPS support
- Troy's reaction to my "half a day" estimate when it took 5 minutes: justified ribbing
- Lesson: trust your own surface area analysis — 4 files, ~150 lines = 10 min job, not half a day

## Evening Session (21:10 - 02:58 UTC)

### SSL Fix
- `assume_ssl = true` BROKE LAN access — browsers got HSTS redirect to HTTPS which doesn't exist on LAN
- Reverted: commented out assume_ssl entirely. Cloudflare handles HTTPS at the edge, LAN stays HTTP
- Lesson: `assume_ssl` tells Rails ALL requests are HTTPS, not just proxied ones

### Setup Wizard Enhancements (major)
- **7-step wizard now:** Welcome → Admin → Network → Storage → Greyhole → Share → Complete
- **Drive detection:** Uses DiskManager (lsblk) to detect all drives including unformatted/unmounted
- **Drive formatting:** Unformatted drives auto-format ext4, unmounted drives mount as-is
- **Filesystem awareness:** Supported fs (ext2/3/4, xfs, btrfs) → pool. Unsupported (ntfs, fat) → standalone share
- **NTFS standalone shares:** Auto-creates network share for unsupported fs drives — no formatting needed
- **Drive preview:** Temp-mount read-only, show top-level directory listing in modal
- **Greyhole install step:** Optional, default 2 copies with 2+ drives, 1 copy warning for single drive
- **Hostname fix:** Added `hostnamectl` to Command privileged_prefixes AND sudoers allowlist

### Samba/nmbd Crash Fix
- Greyhole's dpkg postinst overwrites smb.conf, dropping wide links/follow symlinks settings
- Added `reinject_samba_globals!` to Greyhole.install! that re-injects settings after install
- Also restarts smbd/nmbd after Greyhole install

### UI Changes
- Dashboard link added to upper-right nav (leftmost)
- Docker apps: "Needs subdomain" → "Local access only" + "Open Direct" button
- Vertical centering on app table rows
- OG image: generated 1200x630 PNG via ImageMagick for link previews
- Prepare Drives button gets spinner while processing

### Disk Management (post-wizard)
- "Mount as Share" button in Disks settings for unsupported-fs drives
- Preview button for unmounted drives
- Both wizard and settings pages share the same capabilities

### Proxmox Passthrough
- Raw disk passthrough: `qm set 104 -scsi1 /dev/disk/by-id/<disk-id>`
- Passthrough breaks VM snapshots — must remove before rollback
- `qm unlock 104` to fix locked VM after failed rollback
- For testing wizard: reset `Setting.set('setup_completed', 'false')` instead of reinstalling

### Key Decisions
- Propshaft migration: skip for now, Sprockets works fine
- Firewall plugin: deferred, too big for current state
- No multi-container/compose support planned
- NTFS drives: mount as standalone share, don't try to pool
- Default Greyhole copies: 2 (Troy's call — 1 is not safe)

# 2026-02-24 â€” Daily Log

## Carried over from 2026-02-23
- Troy was testing Docker apps through the proxy on test.enlightenedsolutionsllc.com
- FileBrowser âœ…, Syncthing âœ… (after linuxserver image fix)
- Subdomain apps (Uptime Kuma, Paperless-ngx, etc.) show ðŸ”— indicator â€” need Cloudflare subdomain integration
- Waiting for Troy to continue testing proxy-mode apps (Grafana, Gitea, Transmission, Audiobookshelf)

## Session: Website & Going Public (~04:00 UTC)
- **Repo went public!** First public repo for Troy
- Set up GitHub Pages for amahi-kai.com (static site in `site/`)
- DNS via Namecheap already pointing to GitHub Pages â€” DNS check passed âœ…
- Pages workflow initially failed (Pages wasn't enabled yet) â€” re-ran after config, site went live
- Added branding: favicon.svg/.ico, logo.svg/png, OG meta tags, real logo in navbar
- CI workflow failing (bundle exit code 16) â€” separate issue, probably dependency resolution
- **âš ï¸ MEMORY.md is public in git** â€” contains server IPs, NAS hostname, infra details
  - Troy wants this cleaned up â€” top of TODO list
  - Need to remove from tracking, gitignore, possibly scrub history
- Troy interested in showcasing the AI development story (AGENTS.md, HEARTBEAT.md, SOUL.md) on the website
- All CI runs showing red âŒ â€” not related to going public, was failing before too

## Session: Repo Cleanup & Greyhole & CI (~05:00-08:45 UTC)

### Git History Scrub
- Scrubbed MEMORY.md, HEARTBEAT.md, .claude/, .config/, .npm/, .gemrc, memory/ from git history
- Multiple force pushes required â€” sandbox (.102) has rewritten history, had to push from there
- Troy learned force push workflow: enable in branch protection â†’ push â†’ disable
- All sensitive files now gitignored

### Public Repo Cleanup
- GAMEPLAN.md removed (internal), TODO.md â†’ ROADMAP.md (public-friendly)
- Internal docs removed (TURBO_MIGRATION_PLAN, APP_SYSTEM_OPTIONS)
- Consolidated doc/ into docs/
- Updated README with one-liner install, features list
- Updated CONTRIBUTING.md
- Added repo description, topics, website URL on GitHub
- **v0.1.0 tagged** â€” first public release (pre-release)
- Website links fixed (Docs pointed to nonexistent wiki)
- Nav logo bumped to 48px

### CI Fixed â€” GREEN âœ…
- Root cause: Gemfile.lock had stale gems (removed from Gemfile but still in lockfile)
- Claude on .102 ran `bundle lock --update` to fix
- Additional fixes: tagged Docker/integration/archived specs to skip in CI
- Fixed AppCatalog spec (jellyfin image changed to linuxserver)
- Fixed share_spec (everyone=true is implicit access, not via association)
- Fixed syntax errors in tagged specs (need `integration: true` not `:integration`)
- **CI badge added to README**

### Greyhole Storage Pooling â€” WORKING âœ…
- **Bug fixed:** Config format was wrong â€” wrote INI sections `[test]\n\tnum_copies=1` instead of flat `num_copies[test] = 1`
- **Bug fixed:** UI changes to disk_pool_copies didn't call `Greyhole.configure!`
- **Bug fixed:** `wide links = yes` in smb.conf requires `samba-vfs-modules` package (not installed by default on Ubuntu 24.04)
- Added `samba-vfs-modules` to bin/amahi-install
- Removed hardcoded `wide links = yes` from share.rb smb.conf template (was causing crashes when VFS module missing)
- Verified: 2-copy duplication working across storage-1 and storage-5
- Symlinks in share path work correctly with VFS module installed

### Samba Notes
- `samba-vfs-modules` package REQUIRED for Greyhole symlink-based pooling
- `wide links = yes` + `follow symlinks = yes` + `allow insecure wide links = yes` needed in smb.conf global
- `unix extensions = no` already set
- Without VFS module: `widelinks.so: cannot open shared object file` kills ALL connections
- smb.conf template in share.rb had hardcoded `wide links = yes` â€” removed, needs to be in global config only

### Session 2: Security Audit + Cloudflare Tunnel (~08:55-10:39 UTC)

#### Security Audit Fixes
- **Fix All button inside terminal** wasn't working â€” `closeInstallTerminal` triggers `window.location.reload()` which raced the setTimeout to open fix terminal. Fixed by hiding modal directly instead.
- **SSH fix_ssh_config! bug** â€” single function was setting BOTH `PermitRootLogin no` AND `PasswordAuthentication no` together. Split into separate `fix_sshd_setting!` calls so each only touches its own setting.
- Troy accidentally disabled password SSH via audit Fix All â€” gave him the `sed` command to re-enable.

#### Cloudflare Tunnel UI Overhaul
- **Combined install + configure into single flow** â€” was awkward two-step (install cloudflared â†’ paste token separately). Now: paste token â†’ click Connect â†’ streaming terminal installs + configures + starts all in one.
- **Updated setup instructions** to match current Cloudflare UI:
  - "Install and run connectors" (not "Install connector")
  - "Published applications" tab (not "Public Hostname")
  - Service URL: localhost:3000 (not port 80)
  - Cloudflare renamed tunnels to "connectors" in their UI
- **View logic fix** â€” was showing Start/Stop controls when cloudflared not installed because `token_configured?` returned true from failed service registration. Added `!installed?` check.
- **amahi-kai.com moved to Cloudflare DNS** â€” Troy added domain, quick scan imported GitHub Pages A records + www CNAME correctly. Needed for tunnel connectors (requires CF nameservers).

#### Cloudflare Tunnel â€” BLOCKED
- `cloudflared service install TOKEN` fails with: `sudo: a terminal is required to read the password`
- Sudoers has `amahi ALL=(root) NOPASSWD: /usr/bin/cloudflared` â€” looks correct
- Suspect: `cloudflared service install` itself might invoke sudo internally for systemctl
- **Need to debug**: run `sudo -u amahi sudo /usr/bin/cloudflared service install TOKEN 2>&1` to see real error
- Alternative approach: skip `cloudflared service install` entirely, write the systemd unit file manually and just set the token as an arg
- Added better error capture (stderr output now shown in terminal)
- Added cleanup of leftover systemd unit files before reinstall

#### One-liner Install
- **Working on fresh VM!** Troy rolled back test-kai to clean state and ran `curl -fsSL https://amahi-kai.com/install.sh | sudo bash` â€” clean install confirmed.
- Setup wizard order is correct: Welcome â†’ Admin â†’ Network â†’ Storage â†’ Share â†’ Complete

### Session 3: Codebase Polish + Claude Relay (~19:15-21:22 UTC)

#### Cloudflare Tunnel â€” FIXED âœ…
- Root cause: `cloudflared service install` needs a real TTY internally, even with NOPASSWD sudo
- Fix: Write systemd unit file directly instead of using `cloudflared service install`
- Tunnel connected and working at nas.amahi-kai.com
- Troy also moved proxmox tunnel connector from dedicated VM to directly on Proxmox host

#### Codebase Investigation & Cleanup
- **Phase 1:** Removed 16 unused images, cleaned 17 stale FIXMEs, renamed misleading initializer
- **Phase 2:** Removed entire legacy Amahi app system (~1,650 lines):
  - Models: App (634 lines), Webapp, WebappAlias, AppDependency
  - Libs: amahi_api.rb, amahi_news.rb, downloader.rb
  - 12 old app views, 6 dead controller actions
  - Dashboard switched from App.in_dashboard to DockerApp.dashboard.running
  - Added DockerApp#url method
- **Installer bugs found by Root Claude during testing:**
  - db/seeds.rb referenced deleted models (AppDependency, App, etc.) â€” fixed
  - assets:precompile ran as root, conflicting with amahi-owned cache â€” fixed (runs as amahi user now)
  - manifest.js had `link_tree ../images` but images dir was deleted â€” removed directive

#### Security Audit UI Fixes
- Fix All button in terminal: was reloading page instead of opening fix terminal
- SSH fixes split: root login and password auth are now separate operations
- Fix button spinner: replaced broken HTML entity with Bootstrap spinner

#### Other Fixes
- amahi-update switched from SSH to HTTPS clone URL (public repo)
- amahi-kai.com domain moved to Cloudflare DNS (for tunnel connectors)
- Cloudflare UI instructions updated (Published applications, not Public Hostname)

#### Claude Code Relay System ðŸ†•
- Root Claude built a relay daemon for async communication between sessions
- **To send to Claude:** prefix message with `[CC]` â€” relay extracts to `/root/claude-inbox.md`
- **To receive from Claude:** check `tmp/cc-inbox.md` (Claude writes here)
- Bidirectional async messaging without needing sessions_send
- Need to update HEARTBEAT.md to check cc-inbox (file is root-owned, need Troy/Claude to fix perms)

### Next Up
- Phase 3: Write new specs (CloudflareService, SecurityAudit, Greyhole, setup controller)
- Get HEARTBEAT.md ownership fixed so I can add relay check
- Continue testing one-liner installer end-to-end

### Session 4: Installer Debug Loop with Root Claude (~22:35-01:30 UTC)

#### Agent-to-Agent Relay â€” WORKING âœ…
- Root Claude built relay daemon: kai-relay watches transcript for `[CC]` tags â†’ writes to `/home/troy/claude-inbox.md`
- cc-watcher uses inotify to wake Claude when inbox changes
- I write to `[CC]` prefix, Claude writes to `tmp/cc-inbox.md`
- Full loop tested and confirmed working
- Context exhaustion (1%) can prevent Claude from responding â€” needs fresh session
- **Lesson:** Check `tmp/cc-inbox.md` EVERY heartbeat, not just when prompted

#### Installer Fixes (5 iterations to green)
1. `d7da150` â€” db/seeds.rb referenced deleted models (AppDependency, App, etc.)
2. `35e3db1` â€” assets:precompile permissions (run as amahi user, clear cache)
3. `d3a6561` â€” manifest.js `link_tree ../images` for deleted dir
4. `94dc177` â†’ `826cf1c` â€” Bundler version mismatch. System Ruby 3.2.3 ships bundler 2.4.19 matching Gemfile.lock. Do NOT install any other bundler version.
5. `96c4d6f` â€” MariaDB `CREATE USER IF NOT EXISTS` doesn't update password on reinstall. Added `ALTER USER`.
6. `d4efa5c` â€” **Root cause:** Two Rubies (rbenv 3.2.10 x86_64-linux vs system 3.2.3 x86_64-linux-gnu). Extensions compiled for wrong platform. Fix: disable rbenv when system Ruby detected.

#### CI Fix
- `d13aad3` â€” Removed `spec/models/app_spec.rb` (referenced deleted App model)

#### Clean Install Result: âœ… PASS
- `curl -fsSL https://amahi-kai.com/install.sh | sudo bash` works end-to-end
- Service running, puma on :3000, web UI responding

# 2026-02-16 Session Log

## Troy's Status
- Away for the rest of the day, told me to keep pushing forward autonomously
- Will check in later

## Work Done (Continued from earlier session)

### Security Hardening
- Fixed SQL injection in Db model (parameterized with quote/quote_column_name)
- Fixed shell injection in Db model (Shellwords.escape for mysqldump)
- Fixed shell injection in SystemUtils.unpack and run_script
- Hardened app install/uninstall shell commands (Shellwords.escape)
- Added error handling to share update actions (422 on validation failure)
- Increased admin password minimum from 5 to 8 characters

### New Specs (28 new → 334 total)
- Db model: 6 specs
- CapAccess model: 2 specs
- CapWriter model: 2 specs  
- WebappAlias model: 8 specs
- Container lib: 5 specs
- PartitionUtils lib: 5 specs

### Code Quality
- Removed dead ServerController (unrouted, all actions in SettingsController)
- Removed dead firewall helpers from application_helper.rb (~50 lines)
- Removed unused is_firefox? helper
- Fixed Container.rb typo (alse → false)
- Cleaned up FIXME comments throughout codebase
- Clarified PAM auth limitation, uid convention

### Infrastructure
- Fixed database.yml to use ENV vars for DB name
- Fixed docker-compose.yml (correct DB name amahi_dev, health check)
- Added .dockerignore for lean Docker builds
- Improved Dockerfile (no-install-recommends, asset precompile, dirs)
- Fixed CI config: use SQLite (matches test env), add lib specs step
- Removed commented jQuery gems from Gemfile
- Updated README.md (jQuery-free, security features)
- Updated NOTICE.md (334 specs, jQuery-free)

### Commits
- `1b3a68a` Security hardening + new specs + cleanup
- `3ca789f` Update TODO.md: 334 specs, security audit complete
- `2242838` Clean up dead code: firewall helpers, is_firefox?
- `77fed53` Docker polish: .dockerignore, asset precompile
- `6d49825` Fix CI: use SQLite, add lib specs step
- `fb3c8cc` Add error handling to share update actions
- `07eb072` Clean up FIXMEs, strengthen admin password

## Spec Counts
- Model: 119 (was 101)
- Request: 88
- Feature: 35
- Lib: 92 (was 82)
- **Total: 334** (was 306)

### Additional Commits (continued session)
- `de06fa6` XSS hardening: sanitize app descriptions
- `d7c6406` CONTRIBUTING.md, expanded parameter filtering
- `63f688f` CSS cleanup: vendor prefixes, duplicate properties
- `014559a` Replace bare rescue in share_controller, server.rb
- `3f57669` Scope ALL 17 bare rescue blocks to rescue => e
- `5ef03d6` Production config: enable terser, fix asset debug

### Docker App System (late session)
- `b8abcaa` Docker-based app system — full stack
- `592c00c` Update TODO: 375 specs

## Docker App System Architecture
- **AppCatalog** (lib/app_catalog.rb): YAML catalog at config/docker_apps/catalog.yml
  - 14 curated apps: Nextcloud, Jellyfin, Pi-hole, Gitea, Portainer, Home Assistant, Vaultwarden, Syncthing, Uptime Kuma, Transmission, Paperless-ngx, Immich, Grafana, Audiobookshelf
  - Methods: .all, .find(id), .by_category, .search, .categories
- **ContainerService** (lib/container_service.rb): Docker lifecycle
  - Labels: amahi.managed=true, amahi.app=<id>
  - Stubs all Docker calls in non-production (dev/test)
  - Methods: available?, list, find, pull_image, create, start, stop, restart, remove, status, logs, stats
- **DockerApp** (app/models/docker_app.rb): ActiveRecord model
  - JSON text columns for SQLite compat (port_mappings, volume_mappings, environment)
  - Lifecycle: install!, install_async!, uninstall!, start!, stop!, restart!
- **Controller**: docker_apps, docker_install/uninstall/start/stop/restart/status actions
- **Views**: Docker Apps tab with category filter buttons, per-app status/actions
- **Routes**: Under /tab/apps/docker/* (engine routes had naming issues, used hardcoded paths)
- **Specs**: 41 new (18 model, 12 lib container, 11 lib catalog, 9 request)

## Spec Counts (final)
- Model: 137 (was 119)
- Request: 97 (was 88)
- Feature: 35
- Lib: 106 (was 92)
- **Total: 375** (was 334)

## Notes
- Full model spec suite OOM kills when run all at once — must run in small batches
- Sub-agents work well for parallel spec writing but competing rspec processes cause issues
- 12GB RAM available but bundler+rspec+seeds.rb is memory-hungry
- Engine route helpers (docker_apps_path etc) don't work reliably in views — used hardcoded paths
- Container class renamed to ContainerService (Zeitwerk requires filename=classname)

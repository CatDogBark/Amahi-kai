# 2026-02-20 â€” Daily Log

## Test Suite Progress
- Clean run 3: **643 examples, 36 failures, 23 pending â€” 57.52% coverage**
- Claude fixed `join` nil error (19 failures) â€” committed as 6f50499
- Down to ~17 remaining failures

## Theme Cleanup (completed)
- Deleted Beach theme (broken partials, legacy)
- Rebranded default â†’ "Classic" (steel blue palette, full dark mode)
- Rebranded vertical â†’ "Sidebar" (matching palette, dark mode)
- Added `--kai-*` CSS variable aliases to Classic so dashboard renders correctly
- Updated all theme screenshots and thumbnails from Troy's browser captures
- Replaced old favicon.ico with ocean wave mark
- Copied Amahi-kai logo to Classic and Sidebar themes

## Drive Management Feature (built)
- New "Devices" subtab in Disks plugin
- DiskManager service: detect, format (ext4), mount, unmount drives from web UI
- OS disk protection (won't format/unmount system drive)
- Auto-fstab with UUIDs
- Sudoers entries in installer

## Installer Iteration (big session with Troy on fresh Proxmox VM)
Troy set up test-kai VM (192.168.1.111, Ubuntu 24.04, 4GB RAM, 4 disks)

### Issues found and fixed:
1. **ENV file ordering** â€” bundle install tried to source amahi.env before it was created. Fixed step ordering.
2. **System Ruby** â€” switched from rbenv (10 min compile) to apt ruby package (seconds). Falls back to rbenv if version mismatch.
3. **Gem permissions** â€” system Ruby installs gems to root-owned paths. Fixed with `bundle config path vendor/bundle`.
4. **Git pull prompt** â€” installer tried git pull as root, SSH key prompt blocked install. Removed git pull entirely.
5. **share_files FK mismatch** â€” Rails 8 creates bigint PKs even in Migration[5.1]. share_files.share_id was integer, shares.id was bigint. Fixed by using Rails 8 defaults (bigint FK).
6. **Systemd service paths** â€” hardcoded rbenv paths. Made dynamic based on whether system Ruby or rbenv is used.
7. **VM guest agent** â€” auto-detects KVM/VMware and installs appropriate agent.
8. **Bundler version** â€” apt installs old bundler 2.4.x, we need 4.0.6. Made `gem install bundler` explicit.

### Last status (Troy went to bed):
- Migrations PASSED on fresh install! ðŸŽ‰
- Stuck on `db:seed` â€” asking for amahi's sudo password interactively
- Need to fix seed step to not require interactive sudo

### Installer one-liner:
```bash
git clone git@github.com:CatDogBark/Amahi-kai.git /tmp/amahi-kai && sudo cp -r /tmp/amahi-kai /opt/amahi-kai && rm -rf /tmp/amahi-kai && sudo /opt/amahi-kai/bin/amahi-install
```

## Other Notes
- Troy removed quiet hours restriction â€” reach out anytime
- Docker stack officially retired, native install only
- Troy nervous about going public â€” keeping repo private for now
- TODO: add `bin/amahi-update` command
- TODO: audit/remove bloated gems (dalli, rails-observers, actionpack-action_caching, rustc from apt)
- Troy stepped away ~12:00 UTC

## Evening session with Troy â€” Fresh VM install SUCCESS ðŸŽ‰

### Install completed clean on 192.168.1.111!
- Full `bin/amahi-install` ran start to finish, no manual intervention
- Fixes that got us there:
  - **Ran Rails tasks as root** during install (migrate, seed, assets, reindex) â€” avoids sudoers path-matching issues. `chown -R` after to fix ownership.
  - **Removed terser/nodejs dependency** â€” disabled JS minification, not needed for home server on LAN
  - **Removed legacy DNS nag** â€” "not using your HDA for DNS" warning on login was broken/irrelevant
  - **Replaced emoji branding with SVG logo** in setup wizard (header, welcome, complete pages)
  - **command.rb full-path resolution** â€” `which` lookup so runtime sudo calls match sudoers NOPASSWD rules

### Commits this session:
- `a06068f` â€” command.rb full path resolution for sudoers
- `f2952ad` â€” run installer Rails tasks as root
- `a26432d` â†’ `49f0c9c` â€” removed terser/nodejs (added then removed nodejs from apt)
- `78a78f8` â€” removed DNS nag warning
- `7020c5e` â€” SVG logo in setup wizard

### Where we left off:
- **Setup wizard loaded in browser** at http://192.168.1.111:3000
- Troy logged in with admin/secretpassword, saw wizard welcome page
- Branding fixes (SVG logo, no DNS nag) committed but **NOT yet deployed to test VM**
- Troy needs to update files on test VM to see latest changes, then continue through wizard
- Need to take a new clean snapshot (post-install, pre-wizard) for future rollbacks

## Late night session â€” Update button + deploy key + routing bug

### Built
- `bin/amahi-update` â€” pulls code, bundles, migrates, precompiles, restarts
- "Check for Updates" button in Settings â†’ System Status (uses shared install terminal)
- Update script runs git as amahi user (deploy key), clones fresh if no .git
- Setup wizard dark mode CSS
- `-kai` header color fix (was invisible on teal)
- OS drive filtered from storage pool in setup wizard
- Disk plugin subtab dedup (removed legacy Devices/Partitions row)
- Storage pool toggle â†’ Stimulus AJAX (was doing full page redirect)
- Delete button dark mode visibility fix
- Deploy key generated on test VM (via Proxmox host SSH workaround)

### Routing bug (BLOCKING)
- All plugin tabs (/tab/users, /tab/settings, etc.) return error
- Error: `ActionView::Template::Error: undefined method '+' for nil:NilClass`
- Only dashboard works
- Happens on FRESH install â€” something in our recent commits broke a view
- Need to find which template has the nil concatenation

### Commits this session
- `880c578` â€” setup wizard branding + filter OS drive
- `aff872a` â€” remove duplicate disk subtabs
- `c8e8bec` â€” route disk pool toggle through disks engine
- `381cd61` â€” storage pool AJAX toggle
- `33306bb` â€” bin/amahi-update + Settings update button
- `9ab62ff` â€” refactor to shared install terminal
- `21b5bae` â€” setup wizard dark mode
- `3d5ec22` â€” delete button dark mode
- `d862996` â€” delete button styling all themes
- `78a78f8` â€” remove DNS nag
- `7020c5e` â€” SVG logo in setup wizard
- `c8760cd` â€” update script git fixes

### Deploy key status
- Key generated but VM was rolled back, key lost
- Need to regenerate after next install
- Proxmox host SSH â†’ 111 is the workaround for copy-paste

## Post-session fixes (while Troy sleeps)
- **Sudoers ordering** â€” moved sudoers install before db:seed (User creation runs useradd via sudo)
- **Bloat removal** â€” commented out dalli, actionpack-action_caching, rails-observers, selenium-webdriver, capybara-screenshot from Gemfile. Removed rustc, autoconf, bison, libgdbm-dev, libncurses5-dev, libreadline-dev from installer apt packages.
- Next install attempt should get past the sudo prompt and complete successfully

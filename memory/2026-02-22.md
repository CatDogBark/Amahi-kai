# 2026-02-22 ‚Äî Daily Log

## Session Notes
- Heartbeat check at 04:08 UTC.
- Debugged Docker Apps 500 ‚Äî turned out to be Slim syntax error (`unless/elsif` broken by `== render` of ERB partial inside conditional). Fixed by using separate `if` blocks.
- Also removed emoji from Slim templates and fixed attribute interpolation.
- Advanced Settings rework: removed Guest Dashboard, reworked simple/advanced mode (Network tab hidden in simple, Docker Apps/Servers/Themes/System Status advanced-only), added üîß header toggle.
- Fixed advanced toggle: moved from ApplicationController (not routable) to FrontController. Fixed Settings checkbox to use same endpoint + reload.
- Update terminal now waits for server restart before reloading (polls /login).
- Docker install works! Full 14-app catalog shows after installing Docker on host.
- Troy testing Greyhole with 3 virtual disks ‚Äî initializing, mounting, storage pool.
- Cloudflare Access policy added to test subdomain for security.
- `listen` gem error on host ‚Äî use `RAILS_ENV=production` for rake commands.
- TODO.md updated.

## Evening session (18:12 - 23:33 UTC)
- **Share toggles** ‚Äî all toggles now auto-create Bootstrap spinners, disable during request. Removed page reloads from All Users/access toggles (was collapsing share detail).
- **Share features presets** ‚Äî one-click pill buttons: üóë Recycle Bin, üçé macOS, üëÅ Hide Dotfiles, ‚è∞ Time Machine. Raw editor behind ‚öôÔ∏è in advanced mode.
- **Pool copies** ‚Äî +/- buttons update in-place instead of reloading page.
- **Get the Size** ‚Äî was broken (using toggle controller with no checkbox). Built dedicated fetch function.
- **Gateway Mode** ‚Äî new Network subtab for dnsmasq install + DHCP/DNS config. Install via streaming terminal, stopped+disabled after install until user configures. Removed dnsmasq from default installer.
- **System Status** ‚Äî optional services (dnsmasq, Greyhole, Docker, Cloudflare) only shown if installed.
- **Apps tab rework** ‚Äî killed legacy Available/Installed (dead Amahi app store). Docker Apps is now the main view with Available/Installed subtabs.
- **App install streaming terminal** ‚Äî install button opens terminal with live docker pull/create output. Single shared modal reused for all apps.
- **App logos** ‚Äî switched all to dashboard-icons CDN PNGs (consistent, dark-mode friendly).
- **Start/Stop in-place** ‚Äî JSON responses, JS updates buttons without page reload.
- **Open button** ‚Äî UDPSocket trick for LAN IP (192.168.1.111). Socket.ip_address_list was empty on VM.
- **FileBrowser** ‚Äî added to catalog, installed and running on host port 8085.
- **Gitea** ‚Äî port changed 3000‚Üí3300 to avoid Puma conflict.
- **Multiple Slim syntax bugs** ‚Äî server_ip inside case/when broke parsing, backticks in Slim problematic.
- **VM memory** ‚Äî bumped to 8GB. VS Code Server was eating ~800MB (zombie processes). NAS stack only uses ~400MB.
- Commits: `a125bf4` through `6ec8331` (many)
- Troy traveling, will test Open button from new location.

## Late session (08:53 - 09:16 UTC)
- **Tags toggle fix** ‚Äî `update_tags` action wasn't mapping `params[:name]` to `params[:tags]`, so tag checkboxes silently failed. Fixed controller to translate. Also removed unnecessary page reload on tag toggle.
- **Disks UI consistency** ‚Äî Disks plugin had its own inline Bootstrap `nav-tabs` in all 4 views instead of using the shared subtab system. Registered proper subtabs in `plugin_init.rb`, removed inline tabs. Now matches Shares/Settings style.
- Commits: `a125bf4` (tags fix), `bb42376` (disks subtabs)

## Later session (05:12 - 08:47 UTC)
- **Cloudflare Access** ‚Äî Troy duplicated access policy for test subdomain, quick security win
- **Advanced Settings rework** ‚Äî removed Guest Dashboard, reworked simple/advanced split, added üîß header toggle. Fixed routing (ApplicationController not routable ‚Üí FrontController), fixed checkbox to use same endpoint.
- **Docker Apps 500 fix** ‚Äî Slim `unless/elsif` broken by `== render` of ERB partial. Fixed with separate `if` blocks. Also removed emoji from Slim templates.
- **Docker install works** ‚Äî full 14-app catalog shows after installing Docker on host
- **Update terminal** ‚Äî now waits for server restart before reloading (polls /login)
- **Tab reorder** ‚Äî Users ‚Üí Disks ‚Üí Shares ‚Üí Apps ‚Üí Network ‚Üí Settings (left-to-right workflow)
- **Greyhole integration fixes:**
  - Pool toggle wasn't writing greyhole.conf ‚Üí added `Greyhole.configure!` call
  - `pool_toggle_controller.js` wasn't in application.js manifest
  - systemctl commands used `greyhole` instead of `greyhole.service` (sudoers mismatch)
  - MySQL user password conflict: Greyhole install blanked password, breaking app DB. Fixed to use same DATABASE_PASSWORD from env
  - `generate_config` now includes `db_pass` from DATABASE_PASSWORD env var
  - Install flow now creates MySQL user with correct password
  - Greyhole running with 3 drives (80G pool), share pooling working
- **Disk Pool UI** ‚Äî replaced checkbox with +/- buttons (0=Off, 1=1 copy, 2=2 copies max)
- **Share UX improvements:**
  - Flash notice on share creation
  - Spinner on create button ("Creating...")  
  - Spinner on delete button ("Deleting...")
  - Consistent green banner with 3s auto-dismiss for both
  - Removed confirm dialog from Greyhole install button
  - Fixed share toggle actions returning wrong JSON format
  - Fixed update_tags missing render, update_path calling wrong method
- **Disk management fixes:**
  - Hide OS partitions (/, /boot, /boot/efi) from storage pool list
  - Mount point reuse (find lowest available number, clean up on unmount)
- **Key lesson:** Slim does NOT handle `unless/elsif` blocks when `== render` of ERB partials is inside them. Use separate `if` blocks instead.
- **Key lesson:** Always use `.service` suffix in systemctl commands to match sudoers allowlist exactly.
- **Key lesson:** When multiple services share a MySQL user, don't change the password for one without checking the others.

---
layout: default
title: "Networking"
---

# Networking

Amahi-kai provides DNS alias management and optional DHCP/DNS gateway services through dnsmasq. These features are available in **Advanced mode** under the **Network** tab.

---

## Enabling Advanced Mode

DNS aliases, gateway settings, remote access, and security are all Advanced mode features:

1. Go to **Settings** tab
2. Toggle **Advanced mode** on

---

## DNS Aliases

DNS aliases let you create custom hostnames on your local network that point to your server (or any other IP). For example, you can create `files.local` to reach your Amahi-kai server, or `printer.local` to point to a network printer.

### Creating an Alias

1. Go to **Network > DNS Aliases** (Advanced mode)
2. Enter a **name** (e.g., `files`) — must start with a letter, can contain letters, numbers, and hyphens
3. Optionally enter an **address** — leave blank to point to your server's own IP, or enter a specific IP
4. Click **Create**

### How It Works

When you create, update, or delete a DNS alias, Amahi-kai:

1. Regenerates `/etc/dnsmasq.d/amahi-aliases.conf` from all aliases
2. Restarts dnsmasq to load the new configuration

The generated config file looks like:

```
# Auto-generated by Amahi-kai — do not edit manually
address=/files/
address=/printer/192.168.1.50
address=/nas/
```

An empty address (e.g., `address=/files/`) resolves to the server's own IP.

### Requirements

DNS aliases require dnsmasq to be installed and running. If dnsmasq isn't installed yet, see the [Gateway section](#gateway-dnsmasqdhcpdns) below.

For clients to use your aliases, they must use your Amahi-kai server as their DNS server. This happens automatically if you enable DHCP through the gateway.

---

## Static Hosts

Static hosts map specific MAC addresses to fixed IP addresses (DHCP reservations). Navigate to **Network > Hosts** to manage them.

- **Name**: Friendly name for the device
- **MAC**: The device's MAC address
- **Address**: The last octet of the IP to assign (the network prefix is auto-filled)

---

## Gateway (dnsmasq DHCP/DNS)

The gateway feature turns your Amahi-kai server into a local DHCP and DNS server using dnsmasq. This is optional — your router probably handles DHCP/DNS already.

### When to Use This

- You want DNS aliases to work for all devices on your network
- You want your server to be the authoritative DNS for your local domain
- You want more control over DHCP settings (lease time, IP ranges)
- You're replacing your router's DHCP/DNS with something more configurable

### Installing dnsmasq

1. Go to **Network > Gateway** (Advanced mode)
2. Click **Install dnsmasq**
3. Watch the streaming installation progress

After install, dnsmasq is **stopped and disabled** by default — it won't interfere with your network until you configure and start it.

### Configuring the Gateway

After installation, configure these settings on the Gateway page:

| Setting | Default | Description |
|---------|---------|-------------|
| DHCP Enabled | Yes | Serve DHCP leases to clients |
| DNS Enabled | Yes | Serve DNS responses to clients |
| Gateway IP | `.1` | The router/gateway address (last octet) |
| DHCP Range Low | `.100` | First IP in the DHCP range |
| DHCP Range High | `.254` | Last IP in the DHCP range |
| Lease Time | 14400 seconds | How long a DHCP lease lasts (4 hours) |

Click **Save** to generate the dnsmasq configuration and apply it.

### Generated Configuration

Amahi-kai writes `/etc/dnsmasq.d/amahi.conf`:

```ini
# Amahi-kai dnsmasq configuration
# Auto-generated — do not edit manually

dhcp-range=192.168.1.100,192.168.1.254,14400s
dhcp-option=option:router,192.168.1.1
dhcp-authoritative
local=/local/
expand-hosts
domain=local
bind-interfaces
except-interface=lo
```

### Starting/Stopping dnsmasq

Use the **Start** and **Stop** buttons on the Gateway page, or from the CLI:

```bash
sudo systemctl start dnsmasq
sudo systemctl stop dnsmasq
sudo systemctl status dnsmasq
```

> **Warning**: Running two DHCP servers on the same network will cause conflicts. Disable your router's DHCP before starting Amahi-kai's gateway.

---

## DNS Provider Settings

Under **Network > Settings** (Advanced mode), you can choose upstream DNS providers:

| Provider | DNS Servers |
|----------|-------------|
| OpenDNS | 208.67.222.222, 208.67.220.220 |
| Google | 8.8.8.8, 8.8.4.4 |
| Cloudflare | 1.1.1.1, 1.0.0.1 |
| OpenNIC | (community servers) |
| Custom | Enter your own DNS IPs |

These are the upstream resolvers dnsmasq forwards queries to for external domains.

---

## Network Leases

The **Network** index page shows current DHCP leases — devices that have received an IP address from your dnsmasq server. Each entry shows:

- Hostname
- MAC address
- Assigned IP
- Lease expiry time

---

## Troubleshooting

### DNS aliases not resolving

1. Verify dnsmasq is running: `systemctl is-active dnsmasq`
2. Check the config was generated: `cat /etc/dnsmasq.d/amahi-aliases.conf`
3. Verify clients use your server as DNS:
   ```bash
   # On a client machine:
   nslookup files <server-ip>
   ```
4. If using a router for DHCP, clients may not use your DNS. Either:
   - Switch to Amahi-kai's gateway for DHCP/DNS, or
   - Set your server's IP as the DNS server in your router's DHCP settings

### dnsmasq won't start

```bash
# Check for port conflicts (another DNS service running?)
ss -tlnp | grep :53

# Check dnsmasq config syntax
dnsmasq --test

# View the error
journalctl -u dnsmasq -n 20 --no-pager
```

Common issue: `systemd-resolved` on Ubuntu 24.04 already listens on port 53. To fix:

```bash
# Disable the stub listener
sudo sed -i 's/#DNSStubListener=yes/DNSStubListener=no/' /etc/systemd/resolved.conf
sudo systemctl restart systemd-resolved
sudo systemctl restart dnsmasq
```

### Clients not getting DHCP leases

- Verify dnsmasq is running and DHCP is enabled
- Check the DHCP range doesn't overlap with static assignments
- Ensure no other DHCP server is running (disable your router's DHCP)
- Check the lease file: `cat /var/lib/misc/dnsmasq.leases`
